<?xml version="1.0" encoding="ISO-8859-1"?>
<chapter id="samba-bdc">

<chapterinfo>
	&author.jht;
	&author.vl;
	<author>&person.gd;<contrib>LDAP updates</contrib></author>
	<author>&person.sgw;<contrib>German Translation</contrib></author>
</chapterinfo>

<title>Backup Domänen-Verwaltung</title>

<para>
Bevor Sie diesen Abschnitt lesen, vergewissern Sie sich, daß Sie mit der Konfiguration eines
Samba Domänen-Controllers, wie in <link linkend="samba-pdc"/> beschrieben, vertraut sind.
</para>

<sect1>
<title>Eigenschaften und Vorteile</title>

<para>
Dies ist eines der am schwierigsten zusammenzufassenden Kapitel. Was immer wir auch hier sagen,
jemand wird seine eigenen Schlüsse ziehen und/oder sich dem Samba-Team mit Erwartungen nähern,
die entweder noch nicht erfüllbar sind, bzw. bei mit einem komplett anderen Ansatz bei weitem 
effektiver erfüllt werden können. Im Fall, daß Sie ein fortbestehendes Anliegen haben, das nicht
in diesem Buch behandelt wird, bitte senden Sie eine email an <ulink url="mailto:jht@samba.org">John H. Terpstra</ulink>
, in der Sie Ihre Anforderungen und/oder Fragen klar auseinandersetzen, und wir werden unser Bestes
tun, um Ihnen eine Lösung anzubieten.
</para>

<para>
<indexterm><primary>SAM backend</primary><secondary>LDAP</secondary></indexterm>
Samba-3 ist fähig, als Backup-Domänen-Controller (BDC) für einen Samba Primary-Domänen-Controller (PDC)
zu arbeiten. Ein Samba-3 PDC kann mit einem LDAP-Konten-Backend arbeiten. Das LDAP-Backend kann
entweder ein gängiger Master-LDAP-Server, oder ein LDAP-Slave-Server sein. Die Benutzung eines 
Slave-Servers hat den Vorteil, daß sich in dem Falle, daß der Master nicht verfügbar ist, die Clients
noch immer am Netzwerk anmelden können. Dies hat zur Folge, daß Samba ein hohes Maß an
Skalierbarkeit erhält und dadurch eine effektive Lösung für grosse Organisationen ist.
Wenn Sie einen LDAP-Slave-Server für einen PDC verwenden, werden Sie für die andauernde
Verfügbarkeit des Master-Servers sorgen müssen - wenn der Slave den Master zum falschen
Zeitpunkt nicht erreichen kann, werden Sie Probleme mit dem Betrieb und der Stabilität haben.
</para>

<para>
<indexterm><primary>replication</primary><secondary>SAM</secondary></indexterm>
Während es möglich ist, einen Samba-3 BDC mit einem anderen Backend als LDAP zu betreiben,
muß dieses Backend doch eine Form von '2-Weg'-propogration (sgw ???) von Veränderungen vom
BDC zum Master erlauben. Nur LDAP kann dies zum gegenwärtigen Zeitpunkt.
</para>

<para>
<indexterm><primary>SAM backend</primary><secondary>non-LDAP</secondary></indexterm>
Die Verwendung einer Nicht-LDAP-backend SAM-Datenbank ist teilweise problematisch, weil 
Domänen-Mitglieds-Server und -Workstations regelmässig das Passwort ihres Maschinen-Vertrauens-Kontos
ändern. Das neue Passwort wird dann nur lokal gespeichert. Das bedeutet, daß bei Fehlen einer 
zentral gespeicherten Konten-Datenbank (wie sie mit einer LDAP-basierten Lösung zur Verfügung steht)
und BDC-Betrieb von Samba-3 der BDC-Anteil des Konten-Passworts nicht
in die SAM des PDCs gelangen kann. Wenn dann die SAM des PDCs auf die BDCs repliziert wird, resultiert
dies in dem Überschreiben der SAM, die das veränderte Passwort enthält, was das Domänen-Vertrauensverhältnis
beschädigt.
</para>

<para>
Wenn man die Anzahl der Kommentare und Fragen bedenkt, die sich um die Konfiguration eines BDCs erheben,
macht es Sinn, jede mögliche Option zu bedenken und deren Vor- und Nachteile abzuwägen.
<link linkend="pdc-bdc-table"/> listet mögliche Konfigurationen für eine PDC/BDC Infrastruktur.
<indexterm><primary>net</primary><secondary>rpc</secondary></indexterm>
<indexterm><primary>SAM backend</primary><secondary>ldapsam</secondary></indexterm>
<indexterm><primary>SAM backend</primary><secondary>tdbsam</secondary></indexterm>
<indexterm><primary>replication</primary><secondary>SAM</secondary></indexterm>
</para>

<table frame="all" id="pdc-bdc-table"><title>Optionen zur Verteilung der Domänen-Konten-Datenbank</title>
<tgroup cols="3">
        <colspec align="center" colwidth="1*"/>
        <colspec align="center" colwidth="1*"/>
        <colspec align="left" colwidth="3*"/>

        <thead>
        <row><entry>PDC Backend</entry><entry>BDC Backend</entry><entry>Anmerkungen/Diskussion</entry></row>
        </thead>
        <tbody>
        <row>
        <entry><para>Master LDAP Server</para></entry>
        <entry><para>Slave LDAP Server</para></entry>
        <entry><para>Die optimale Lösung, die hohe Integrität gewährleistet. Die SAM wird auf einen
		üblichen LDAP-Master-Server repliziert.</para></entry>
        </row>
        <row>
        <entry><para>Single Central LDAP Server</para></entry>
        <entry><para>Single Central LDAP Server</para></entry>
	<entry><para>
	Eine funktionierende Lösung ohne Failover-Fähigkeiten. Dies ist eine brauchbare Lösung, jedoch nicht optimal.
	</para></entry>
        </row>
        <row>
        <entry><para>tdbsam</para></entry>
        <entry><para>tdbsam + <command>net rpc vampire</command></para></entry>
        <entry><para>
	Funktioniert NICHT mit Samba-3.0.0; könnte in einer späteren Release implementiert werden. Der Nachteil dieser
	Lösung ist, daß ein externer Prozess die Integrität der Konten-DB überwacht. Diese Lösung erscheint für
	Sites interessant, die die Komplexität von LDAP vermeiden wollen. Der Befehl <command>net rpc vampire</command> 
	wird verwendet, um die Domänen-Konten des PDCs auf den BDC zu synchronisieren.	
	</para></entry>
        </row>
        <row>
        <entry><para>tdbsam</para></entry>
        <entry><para>tdbsam + <command>rsync</command></para></entry>
        <entry><para>
	Verwenden Sie diese Konfiguration NICHT.
	Sie funktioniert nicht, weil die tdb-files geöffnet sind und deren Daten noch nicht auf die Platte
	geschrieben worden sein könnten.
	Verwenden Sie <command>rsync</command>, um die tdb-files vom PDC auf den BDC zu synchronisieren.	
	</para></entry>
        </row>
        <row>
        <entry><para>smbpasswd file</para></entry>
        <entry><para>smbpasswd file</para></entry>
        <entry><para>
	Verwenden Sie diese Konfiguration NICHT.
	Dies ist keine elegante Lösung, wegen der Verzögerungen bei der Synchronisation.
	Verwenden Sie <command>rsync</command>, um die tdb-files vom PDC auf den BDC zu synchronisieren.
	Kann zum Funktionieren gebracht werden, mittels Verwendung eines <command>cron</command> job zur
	Synchronisation.
	</para></entry>
        </row>
        </tbody>
</tgroup>
</table>

</sect1>

<sect1>
<title>Essentielle Hintergrund-Informationen</title>

<para>
Ein Domänen-Controller ist eine Maschine, die imstande ist, Anmeldeanforderungen von
Netzwerk-Workstations zu beantworten.  Microsoft LanManager und IBM LanServer waren zwei
frühe Produkte, die diese Fähigkeit zur Verfügung stellten. Diese Technologie wurde als
das LanMan Netlogon-Service bekannt.
</para>

<para>
Als MS Windows NT3.10 veröffentlicht wurde, unterstützte es eine neue Art der Domänen-Verwaltung
und damit eine neue Form von Netzwerk-Anmelde-Dienst, die erweiterte Funktionalität hat.
Dieser Dienst wurde als NT-NetLogon-Service bekannt. Die Natur dieses Dienstes hat sich im Laufe
der Evolution von MS Windows NT verändert und bietet heute ein komplexes Feld von Diensten, die 
über ein kompliziertes Spektrum von Technologien reichen.
</para>

<sect2>
<title>MS Windows NT4-style Domänen-Verwaltung</title>

<para>
Wenn immer sich ein Benutzer an einer Windows NT4/200x/XP Professional Workstation anmeldet,
verbindet sich die Workstation mit einem Domänen-Controller (Authentifikations-Server), um
zu prüfen, ob der Benutzername und das Passwort, die vom Benutzer eingegeben wurden, gültig sind.
Wenn die eingegebene Information nicht mit der Konto-Information übereinstimmt, die in der
Domänen-Verwaltungs-Datenbank (die SAM, oder Security Account Manager Datenbank) abgelegt ist,
wird ein Satz von Fehler-Codes an die Workstation retourniert, die die Anmelde-Anfrage gestellt hat.
</para>

<para>
Wenn das Benutzername/Passwort-Paar überprüft wurde, antwortet der Domänen-Controller 
(Authentifikations-Server) mit einer vollständigen Aufzählung von der Konto-Information, die
bezüglich des Benutzers in der Benutzer- und Maschinen-Konten-DB für diese Domäne gespeichert ist.
Diese Information enthält ein komplettes Netzwerk-Zugriffs-Profil für den Benutzer, aber schließt
jegliche Information aus, die spezifisch für das Desktop-Profil des Benutzers ist, oder schließt zu
Zweck alle Desktop-Profile für jene Gruppen aus, denen der Benutzer angehört. Die Information
enthält Passwort-Zeit-Limits, Passwort-Einzigartigkeits-Überprüfungen, Netzwerk-Zugriffs-Zeit-Limits,
Konten-Gültigkeits-Information, Maschinen-Namen, von welchen aus der Benutzer auf das Netzwerk
zugreifen kann, und vieles mehr. All diese Information wurde von allen Versionen von MS Windows NT 
(3.10, 3.50, 3.51, 4.0) in der SAM gespeichert.
</para>

<para>
<indexterm><primary>Replikation</primary><secondary>SAM</secondary></indexterm>
Die Konten-Information (Benutzer und Maschine) wird auf Domänen-Controllern in 2 Dateien
gespeichert, eine enthält die Sicherheits-Information, die andere die SAM. Diese werden in 
gleichnamigen Dateien im Verzeichnis <filename>C:\Windows NT\System32\config</filename> gespeichert.
Dies sind die Dateien, die in die Replikation der SAM involviert sind, wenn Backup-Domänen-Controller
im Netzwerk vorhanden sind.
</para>

<para>
Es gibt 2 Situationen in welchen es wünschenswert ist, Backup-Domänen-Controller zu installieren:
</para>

<itemizedlist>
	<listitem><para>
	Im lokalen Netzwerk des PDCs, wenn es viele Workstations gibt, und/oder wenn
	der PDC generell sehr stark ausgelastet ist. In diesem Fall werden die BDCs 
	Anmelde-Anforderungen übernehmen und mithelfen, die Robustheit des Netzes zu erhöhen.
	</para></listitem>

	<listitem><para>
	In jeder entfernten Filiale/Abteilung/Installation, um WAN-Verkehr zu reduzieren, und um
	die Stabilität der Netzwerk-Operationen zu erhöhen. Das Design des Netzwerks, das strategische
	Platzieren von BDCs, gemeinsam mit einer Implementierung, die den Client-Netzwerk-Austausch
	möglichst lokal hält, wird den Bedarf an WAN-Bandbreite minimieren helfen (und damit auch
	deren Kosten).
	</para></listitem>
</itemizedlist>

<para>
Die Interaktion von PDC und seinen BDCs in einem Windows NT4-Environment ist es wert, hier
erwähnt zu werden. Der PDC enthält die Master-Kopie der SAM. In dem Fall, daß ein Administrator
eine Änderung an der Benutzer-Konten-Datenbank vornimmt, während er physisch im LAN des PDCs ist,
wird die Veränderung wahrscheinlich direkt am PDC durchgeführt, anstatt in der Master-Kopie der SAM.
Im Falle, daß diese Veränderung in einer Zweigstelle durchgeführt wird, wird diese Änderung
wahrscheinlich in einem Delta-file auf dem lokalen BDC gespeichert. Der BDC wird dann einen Trigger
an den PDC senden, um die Synchronisation der SAM zu beginnen. Dann wird der PDC das Delta-file vom
BDC anfordern und es auf die Master-SAM anwenden. Danach wird der PDC alle BDCs in der Domäne
kontaktieren, und per Trigger veranlassen, sich das Update zu holen, und es in ihre eigene Kopie
der SAM einzuspielen.
</para>

<para>
Samba-3 kann nicht an wirklicher SAM-Replikation teilnehmen, und ist daher nicht geeignet, exakt
dieselben Protokolle zu verwenden wie MS Windows NT4. Ein Samba-3-BDC wird keine SAM-Update-Delta-files
generieren. Es wird nicht mit einem PDC (NT4 oder Samba) zusammenarbeiten, um die SAM mittels Delta-files
von BDCS zu synchronisieren.
</para>

<para>
Samba-3 kann nicht als BDC für einen MS Windows NT4 PDC arbeiten, und Samba-3 kann nicht korrekt als
PDC für einen MS Windows NT4 BDC arbeiten. Sowohl Samba-3 als auch MS Windows NT4 können als BDC für
ihren eigenen Typ von PDC arbeiten.
</para>

<para>
Der BDC hält eine <emphasis>read-only</emphasis>-Version der SAM

--- sgw



The BDC is said to hold a <emphasis>read-only</emphasis> of the SAM from which
it is able to process network logon requests and authenticate users. The BDC can
continue to provide this service, particularly while, for example, the wide area
network link to the PDC is down. A BDC plays a very important role in both the
maintenance of Domain Security as well as in network integrity.
</para>

<para>
In the event that the NT4 PDC should need to be taken out of service, or if it dies, 
one of the NT4 BDCs can be promoted to a PDC. If this happens while the original NT4 PDC is on
line, it is automatically demoted to an NT4 BDC. This is an important aspect of Domain
Controller management. The tool that is used to effect a promotion or a demotion is the
Server Manager for Domains. It should be noted that Samba-3 BDCs can not be promoted
in this manner because reconfiguration of Samba requires changes to the &smb.conf; file.
</para>

<sect3>
<title>Example PDC Configuration</title>

<para>
Beginning with Version 2.2, Samba officially supports domain logons for all current Windows clients,
including Windows NT4, 2003 and XP Professional. For Samba to be enabled as a PDC, some
parameters in the <smbconfsection>[global]</smbconfsection>-section of the &smb.conf; have to be set.
Refer to <link linkend="minimalPDC"/> for an example of the minimum required settings.
</para>

<para><smbconfexample id="minimalPDC">
<title>Minimal smb.conf for a PDC in Use With a BDC &smbmdash; LDAP Server on PDC.</title>
<smbconfoption><name>workgroup</name><value>&example.workgroup;</value></smbconfoption>
<smbconfoption><name>passdb backend</name><value>ldapsam://localhost:389</value></smbconfoption>
<smbconfoption><name>domain master</name><value>yes</value></smbconfoption>
<smbconfoption><name>domain logons</name><value>yes</value></smbconfoption>
</smbconfexample></para>

<para>
Several other things like a <smbconfsection>[homes]</smbconfsection> and a
<smbconfsection>[netlogon]</smbconfsection> share also need to be set along with
settings for the profile path, the user's home drive, and so on. This is not covered in this
chapter; for more information please refer to <link linkend="samba-pdc"></link>.
</para>

</sect3>
</sect2>

<sect2>
<title>LDAP Configuration Notes</title>

<para>
When configuring a master and a slave LDAP server, it is advisable to use the master LDAP server
for the PDC and slave LDAP servers for the BDCs. It is not essential to use slave LDAP servers, however,
many administrators will want to do so in order to provide redundant services. Of course, one or more BDCs
may use any slave LDAP server. Then again, it is entirely possible to use a single LDAP server for the
entire network.
</para>

<para>
When configuring a master LDAP server that will have slave LDAP servers, do not forget to configure
this in the <filename>/etc/openldap/slapd.conf</filename> file. It must be noted that the DN of a
server certificate must use the CN attribute to name the server, and the CN must carry the servers'
fully qualified domain name. Additional alias names and wildcards may be present in the
subjectAltName certificate extension. More details on server certificate names are in RFC2830.
</para>

<para>
It does not really fit within the scope of this document, but a working LDAP installation is
basic to LDAP enabled Samba operation. When using an OpenLdap server with Transport Layer Security
(TLS), the machine name in <filename>/etc/ssl/certs/slapd.pem</filename> must be the
same as in <filename>/etc/openldap/sldap.conf</filename>. The Red Hat Linux startup script
creates the <filename>slapd.pem</filename> file with hostname <quote>localhost.localdomain.</quote>
It is impossible to access this LDAP server from a slave LDAP server (i.e., a Samba BDC) unless the
certificate is recreated with a correct hostname.
</para>

<para>
Do not install a Samba PDC on a OpenLDAP slave server. Joining client machines to the domain
will fail in this configuration because the change to the machine account in the LDAP tree
must take place on the master LDAP server. This is not replicated rapidly enough to the slave
server that the PDC queries. It therfore gives an error message on the client machine about
not being able to set up account credentials. The machine account is created on the LDAP server
but the password fields will be empty.
</para>

<para>
Possible PDC/BDC plus LDAP configurations include:
</para>

<itemizedlist>
	<listitem><para>
	PDC+BDC -> One Central LDAP Server.
	</para></listitem>
	<listitem><para>
	PDC -> LDAP master server, BDC -> LDAP slave server.
	</para></listitem>
	<listitem><para>
	PDC -> LDAP master, with secondary slave LDAP server.
	</para><para>
	BDC -> LDAP master, with secondary slave LDAP server.
	</para></listitem>
	<listitem><para>
	PDC -> LDAP master, with secondary slave LDAP server.
	</para><para>
	BDC -> LDAP slave server, with secondary master LDAP server.
	</para></listitem>
</itemizedlist>

<para>
In order to have a fall-back configuration (secondary) LDAP server one would specify
the secondary LDAP server in the &smb.conf; file as shown in <link linkend="mulitldapcfg"/>.
</para>

<para>
<smbconfexample id="mulitldapcfg">
<title>Multiple LDAP Servers in &smb.conf;</title>
<member>...</member>
<smbconfoption><name>passdb backend</name><value> </value></smbconfoption>
<member><parameter>ldapsam:"ldap://master.quenya.org ldap://slave.quenya.org"</parameter></member>
<member>...</member>
</smbconfexample>
</para>

</sect2>

<sect2>
<title>Active Directory Domain Control</title>

<para>
As of the release of MS Windows 2000 and Active Directory, this information is now stored
in a directory that can be replicated and for which partial or full administrative control
can be delegated. Samba-3 is not able to be a Domain Controller within an Active Directory
tree, and it cannot be an Active Directory server. This means that Samba-3 also cannot
act as a Backup Domain Controller to an Active Directory Domain Controller.
</para>

</sect2>

<sect2>
<title>What Qualifies a Domain Controller on the Network?</title>

<para>
Every machine that is a Domain Controller for the domain MIDEARTH has to register the NetBIOS
group name MIDEARTH&lt;#1c&gt; with the WINS server and/or by broadcast on the local network.
The PDC also registers the unique NetBIOS name MIDEARTH&lt;#1b&gt; with the WINS server.
The name type &lt;#1b&gt; name is normally reserved for the Domain Master Browser, a role
that has nothing to do with anything related to authentication, but the Microsoft Domain
implementation requires the Domain Master Browser to be on the same machine as the PDC.
</para>

<para>
Where a WINS server is not used, broadcast name registrations alone must suffice. Refer to
<link linkend="netdiscuss"/> for more information regarding TCP/IP network protocols and how
 SMB/CIFS names are handled.
</para>

</sect2>

<sect2>
<title>How does a Workstation find its Domain Controller?</title>

<para>
There are two different mechanisms to locate a domain controller, one method is used when
NetBIOS over TCP/IP is enabled and the other when it has been disabled in the TCP/IP
network configuration.
</para>

<para>
Where NetBIOS over TCP/IP is disabled, all name resolution involves the use of DNS, broadcast
messaging over UDP, as well as Active Directory communication technologies. In this type of
environment all machines require appropriate DNS entries. More information may be found in
<link linkend="adsdnstech"/>.
</para>

<sect3>
<title>NetBIOS Over TCP/IP Enabled</title>
<para>
An MS Windows NT4/200x/XP Professional workstation in the domain MIDEARTH that wants a
local user to be authenticated has to find the Domain Controller for MIDEARTH. It does this
by doing a NetBIOS name query for the group name MIDEARTH&lt;#1c&gt;. It assumes that each
of the machines it gets back from the queries is a Domain Controller and can answer logon
requests. To not open security holes, both the workstation and the selected Domain Controller
authenticate each other. After that the workstation sends the user's credentials (name and
password) to the local Domain Controller for validation.
</para>

</sect3>

<sect3>
<title>NetBIOS Over TCP/IP Disabled</title>

<para>
An MS Windows NT4/200x/XP Professional workstation in the realm <constant>quenya.org</constant>
that has a need to affect user logon authentication will locate the Domain Controller by 
requerying DNS servers for the <constant>_ldap._tcp.pdc.ms-dcs.quenya.org</constant> record.
More information regarding this subject may be found in <link linkend="adsdnstech"/>.
</para>

</sect3>
</sect2>
</sect1>

<sect1>
<title>Backup Domain Controller Configuration</title>

<para>
The creation of a BDC requires some steps to prepare the Samba server before
&smbd; is executed for the first time. These steps are outlines as follows:
<indexterm><primary>SID</primary></indexterm>
</para>

<itemizedlist>
<listitem><para>
	The domain SID has to be the same on the PDC and the BDC. In Samba versions
	pre-2.2.5, the domain SID was stored in the file <filename>private/MACHINE.SID</filename>.
	The domain SID is now stored in the file <filename>private/secrets.tdb</filename>. This file
	is unique to each server and can not be copied from a PDC to a BDC, the BDC will generate
	a new SID at start-up. It will over-write the PDC domain SID with the newly created BDC SID.
	There is a procedure that will allow the BDC to aquire the Domain SID. This is described here.
	</para>

	<para>
	To retrieve the domain SID from the PDC or an existing BDC and store it in the
	<filename>secrets.tdb</filename>, execute:
	</para>
<screen>
&rootprompt;<userinput>net rpc getsid</userinput>
</screen>
	</listitem>

	<listitem><para>
	Specification of the <smbconfoption><name>ldap admin dn</name></smbconfoption> is obligatory.
	This also requires the LDAP administration password to be set in the <filename>secrets.tdb</filename>
	using the <command>smbpasswd -w <replaceable>mysecret</replaceable></command>.
	</para></listitem>

	<listitem><para>
	Either <smbconfoption><name>ldap suffix</name></smbconfoption> or
	<smbconfoption><name>ldap idmap suffix</name></smbconfoption> must be specified in
	the &smb.conf; file.
	</para></listitem>

	<listitem><para>
<indexterm><primary>replication</primary><secondary>SAM</secondary></indexterm>
	The UNIX user database has to be synchronized from the PDC to the
	BDC. This means that both the <filename>/etc/passwd</filename> and
	<filename>/etc/group</filename> have to be replicated from the PDC
	to the BDC. This can be done manually whenever changes are made. 
	Alternately, the PDC is set up as an NIS master server and the BDC as an NIS slave
	server. To set up the BDC as a mere NIS client would not be enough,
	as the BDC would not be able to access its user database in case of
	a PDC failure. NIS is by no means the only method to synchronize
	passwords. An LDAP solution would also work.
	</para>
	</listitem>

	<listitem><para>
	The Samba password database must be replicated from the PDC to the BDC.
	Although it is possible to synchronize the <filename>smbpasswd</filename>
	file with <command>rsync</command> and <command>ssh</command>, this method
	is broken and flawed, and is therefore not recommended. A better solution
	is to set up slave LDAP servers for each BDC and a master LDAP server for the PDC.
	</para></listitem>

	<listitem><para>
	The netlogon share has to be replicated from the PDC to the
	BDC. This can be done manually whenever login scripts are changed,
	or it can be done automatically using a <command>cron</command> job
	that will replicate the directory structure in this share using a tool
	like <command>rsync</command>.
	</para></listitem>

</itemizedlist>

<sect2>
<title>Example Configuration</title>

<para>
Finally, the BDC has to be found by the workstations. This can be done by setting Samba as shown in <link linkend="minim-bdc"/>.
</para>

<para><smbconfexample id="minim-bdc">
<title>Minimal setup for being a BDC</title>
<smbconfoption><name>workgroup</name><value>&example.workgroup;</value></smbconfoption>
<smbconfoption><name>passdb backend</name><value>ldapsam:ldap://slave-ldap.quenya.org</value></smbconfoption>
<smbconfoption><name>domain master</name><value>no</value></smbconfoption>
<smbconfoption><name>domain logons</name><value>yes</value></smbconfoption>
<smbconfoption><name>idmap backend</name><value>ldap:ldap://slave-ldap.quenya.org</value></smbconfoption>
</smbconfexample></para>

<para>
In the <smbconfsection>[global]</smbconfsection>-section of the &smb.conf; of the BDC. This makes the BDC
only register the name SAMBA&lt;#1c&gt; with the WINS server. This is no
problem as the name SAMBA&lt;#1c&gt; is a NetBIOS group name that is meant to
be registered by more than one machine. The parameter
<smbconfoption><name>domain master</name><value>no</value></smbconfoption>
forces the BDC not to register <?latex \linebreak ?>SAMBA&lt;#1b&gt; which as a unique NetBIOS
name is reserved for the Primary Domain Controller.
</para>

<para>
<indexterm><primary>idmap backend</primary></indexterm>
<indexterm><primary>winbindd</primary></indexterm>
The <parameter>idmap backend</parameter> will redirect the <command>winbindd</command> utility to
use the LDAP database to resolve all UIDs and GIDs for UNIX accounts.
</para>

<note><para>
<indexterm><primary>Server Type</primary><secondary>Domain Member</secondary></indexterm>
Samba-3 has introduced a new ID mapping facility. One of the features of this facility is that it
allows greater flexibility in how user and group IDs are handled in respect to NT Domain User and Group
SIDs. One of the new facilities provides for explicitly ensuring that UNIX/Linux UID and GID values
will be consistent on the PDC, all BDCs and all Domain Member servers. The parameter that controls this
is called <parameter>idmap backend</parameter>. Please refer to the man page for &smb.conf; for more information
regarding its behavior.
</para></note>

<para>
The use of the <smbconfoption><name>idmap backend</name><value>ldap:ldap://master.quenya/org</value></smbconfoption>
option on a BDC only make sense where ldapsam is used on a PDC. The purpose for an LDAP based idmap backend is
also to allow a domain-member (without its own passdb backend) to use winbindd to resolve Windows network users
and groups to common UID/GIDs. In other words, this option is generally intended for use on BDCs and on Domain
Member servers.
</para>

</sect2>
</sect1>

<sect1>
<title>Common Errors</title>

<para>
As this is a rather new area for Samba, there are not many examples that we may refer to.
Updates will be published as they become available and may be found in later Samba releases or
from the Samba web <ulink url="http://samba.org">site.</ulink>
</para>

<sect2>
<title>Machine Accounts Keep Expiring</title>

<para>
<indexterm><primary>Machine Trust Accounts</primary></indexterm>
This problem will occur when the passdb (SAM) files are copied  from a central
server but the local Backup Domain Controller is acting as a PDC. This results in the application of
Local Machine Trust Account password updates to the local SAM. Such updates 
are not copied back to the central server. The newer machine account password is then over
written when the SAM is re-copied from the PDC. The result is that the Domain Member machine
on start up will find that its passwords do not match the one now in the database and
since the startup security check will now fail, this machine will not allow logon attempts
to proceed and the account expiry error will be reported.
</para>

<para>
The solution is to use a more robust passdb backend, such as the ldapsam backend, setting up
a slave LDAP server for each BDC, and a master LDAP server for the PDC.
</para>

</sect2>

<sect2>
<title>Can Samba Be a Backup Domain Controller to an NT4 PDC?</title>

<para>
<indexterm><primary>replication</primary><secondary>SAM</secondary></indexterm>
No. The native NT4 SAM replication protocols have not yet been fully implemented.
</para>

<para>
Can I get the benefits of a BDC with Samba?  Yes, but only to a Samba PDC.The
main reason for implementing a BDC is availability. If the PDC is a Samba
machine, a second Samba machine can be set up to service logon requests whenever
the PDC is down.
</para>

</sect2>

<sect2>
<title>How Do I Replicate the smbpasswd File?</title>

<para>
<indexterm><primary>replication</primary><secondary>SAM</secondary></indexterm>
Replication of the smbpasswd file is sensitive. It has to be done whenever changes
to the SAM are made. Every user's password change is done in the smbpasswd file and
has to be replicated to the BDC. So replicating the smbpasswd file very often is necessary.
</para>

<para>
As the smbpasswd file contains plain text password equivalents, it must not be
sent unencrypted over the wire. The best way to set up smbpasswd replication from
the PDC to the BDC is to use the utility rsync. rsync can use ssh as a transport.
<command>ssh</command> itself can be set up to accept <emphasis>only</emphasis>
<command>rsync</command> transfer without requiring the user to type a password.
</para>

<para>
As said a few times before, use of this method is broken and flawed. Machine trust 
accounts will go out of sync, resulting in a broken domain. This method is
<emphasis>not</emphasis> recommended. Try using LDAP instead.
</para>

</sect2>

<sect2>
<title>Can I Do This All with LDAP?</title>

<para>
The simple answer is yes. Samba's pdb_ldap code supports binding to a replica
LDAP server, and will also follow referrals and rebind to the master if it ever
needs to make a modification to the database. (Normally BDCs are read only, so
this will not occur often).
</para>

</sect2>
</sect1>
</chapter>
