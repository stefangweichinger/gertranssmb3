<?xml version="1.0" encoding="ISO-8859-1"?>
<chapter id="diagnosis">
<chapterinfo>
	&author.tridge;
	&author.jelmer;
	&author.danshearer;
	<pubdate>Wed Jan 15</pubdate>
	 <author>&person.reiss;<contrib>German Translator</contrib></author>
</chapterinfo>

<title>Die Samba Checkliste</title>

<sect1>
<title>Einleitung</title>

<para>
Dieses Dokument beschreibt eine Reihe von Tests zur Überprüfung Ihres
Sambaservers. Wenn bei den Tests Probleme festgestellt werden bietet
es ferner Informationen über die möglichen Fehlerursachen.
Wurden alle Tests fehlerfrei durchgeführt sollte alles einwandfrei
funktionieren.
</para>

<para>
Sie sollten alle Tests in der genannten Reihenfolge durchführen.
Es wurde sorgfältig versucht die Reihenfolge so auszuwählen, 
dass nachfolgende Test's auf erfolgreich durchgeführte frühere Test's 
aufbauen.
Auch nachdem ein Fehler behoben wurde sollten Sie immer alle
Test's komplett durchführen.
</para>

<para>
Wenn Sie eine E-Mail an eine der Samba Mailing Listen mit dem Inhalt
<quote>Es funktioniert nicht</quote> schicken ohne diese Test's
durchgeführt zu haben, so wundern Sie sich bitte nicht wenn Ihre E-Mail
ingoriert wird.
</para>

</sect1>

<sect1>
<title>Vorwort</title>

<para>
In allen Test wird davon ausgegangen, dass Sie eine Sambaserver
BIGSERVER und einen PC ACLIENT haben welche sich in der Arbeitsgruppe
TESTGROUP befinden.
</para>

<para>
Das Vorgehen ist für andere Typen von Clients vergleichbar.
</para>

<para>
Des weiteren wird angenommen, dass Sie den Namen einer verfügbaren Freigabe in Ihrer
&smb.conf; kennen. Ich werden hier die Freigabe mit dem Namen
<smbconfsection>tmp</smbconfsection> verwenden.
Sie können solch eine Freigabe durch folgende Zeilen erstellen <link linkend="tmpshare"/>.
</para>

<para><smbconfexample id="tmpshare">
<title>smb.conf mit [tmp] Freigabe</title>
<smbconfsection>[tmp]</smbconfsection>
<smbconfoption><name>comment</name><value>temporary files </value></smbconfoption>
<smbconfoption><name>path</name><value>/tmp</value></smbconfoption>
<smbconfoption><name>read only</name><value>yes</value></smbconfoption>
</smbconfexample>
</para>

<note><para>
Diese Test's setzen Samba in der Version 3.0.0 oder später vorraus.
Einige der genannten Befehle sind in früheren Samba Versionen nicht
enthalten.
</para></note>

<para>
Bitte schenken Sie den gemeldeten Fehlermeldungen Ihre Aufmerksamkeit.
Sollten Sie eine Fehlermeldung erhalten, dass Ihr Server "unfriendly"
wäre überprüfen Sie bitte ob Ihre IP Namensauflösung korrekt eingestellt
ist.
Stellen Sie sicher dass in der Datei
<filename>/etc/resolv.conf</filename> ein korrekter Nameserver
eingetragen wurde.
</para>

<para>
Sollten Sie keinen DNS Server einsetzen überprüfen Sie ob ihre
&smb.conf; die Zeile <command>dns proxy = no</command> enthält.
Der beste Weg das zu überprüfen ist der Befehl <command>testparm smb.conf</command>.
</para>


<para>
<indexterm><primary>Log Dateien</primary><secondary>Überwachung</secondary></indexterm>
Es ist hilfreich während der Test's die Log Dateien in einem separatem
Konsolenfenster (mittels ctrl-alt-F1 bis F6 oder mehrere Fenster in X)
mittels <command>tail -F log_file_name</command> zu überwachen.
Die wichtigen Log Dateien finden Sie (in der Default Installation) 
unter <filename>/usr/local/samba/var</filename>.
Sie können hier des weiteren die Verbindunglogs von Computern finden
oder evtl. auch in <filename>/var/log/samba</filename>, je nachdem wie Sie es in
&smb.conf; angegeben haben.
</para>

<para>
Sollten Sie während der Test's Änderungen an der &smb.conf; durchführen,
vergessen Sie bitte nicht &smbd; und &nmbd; neu zu starten.
</para>

</sect1>

<sect1>
<title>Die Test's</title>
<procedure>
<title>Diagnose Ihres Samba Server</title>


<step performance="required">
<para>
<indexterm><primary>testparm</primary></indexterm>
Rufen Sie im Verzeichniss Ihrer &smb.conf; 
den Befehl <command>testparm smb.conf</command> auf. Werden Fehler
angezeigt ist Ihre &smb.conf; nicht in Ordnung.
</para>

<note><para>
Ihre &smb.conf; sollte in <filename>/etc/samba</filename> oder in
<filename>/usr/local/samba/lib</filename> zu finden sein.
</para></note>
</step>

<step performance="required">
<para>
Führen Sie auf Ihrem PC den Befehl <command>ping BIGSERVER</command> und 
auf Ihrem Unix Server den Befehl <command>ping ACLIENT</command> 
aus. Erhalten Sie keine gültige Antwort, so ist TCP/IP nicht korrekt
eingerichtet.
</para>

<para>
Sie müssen an Ihrem PC eine <quote>Dos Eingabeaufforderung</quote>
öffnen um den Befehl ping auszuführen.
</para>

<para>
Erhalten Sie eine Meldung in der Art von <quote><errorname>host not found</errorname></quote>
dann ist Ihre DNS Konfiguration oder die Datei
<filename>/etc/hosts</filename> nicht in Ordnung. Es ist möglich Samba
ohne DNS Einträge für den Server oder die Client's zu betreiben, aber es
wird für die weiteren Test's davon ausgegangen das diese Einträge
korrekt sind.
</para>

<para>
Eine weitere Möglichkeit warum ein ping nicht funktioniert ist eine
vorhandene Firewall. Sie müssen die Regeln der Firewall dahingehend
anpassen um die Workstation evtl. von einem anderen Subnetz 
zugreifen lassen zu können.
Unter Linux können Sie dies mit dem Firewall Programmen
<command>ipchains</command> oder <command>iptables</command>
durchführen.
</para>

<note>
<para>
Moderne Linux Distributionen installieren per Default ipchains/iptables.
Das ist ein gängiges Problem und wird gerne übersehen.
</para>
</note>

<para>
Möchten Sie die Firewallregeln des Testsystems überprüfen rufen Sie
einfach 
<command>iptables -L -v</command> oder bei <parameter>ipchains</parameter>-basierenden Firewalls 
<command>ipchains -L -v</command> auf.
</para>

<para>
Hier ist eine beispielhafte Ausgabe eines System mit einer externen
Ethernet Schnittstelle (eth1), an dem Samba nicht aktiv ist, und einer
internen (Privates Netzwerk) Ethernet Schnittstelle (eth0) an dem Samba aktiv
ist.
<screen>
frodo:~ # iptables -L -v
Chain INPUT (policy DROP 98496 packets, 12M bytes)
 pkts bytes target     prot opt in     out     source     destination
 187K  109M ACCEPT     all  --  lo     any     anywhere   anywhere
 892K  125M ACCEPT     all  --  eth0   any     anywhere   anywhere
1399K 1380M ACCEPT     all  --  eth1   any     anywhere   anywhere  \
					state RELATED,ESTABLISHED

Chain FORWARD (policy DROP 0 packets, 0 bytes)
 pkts bytes target     prot opt in     out     source     destination
 978K 1177M ACCEPT     all  --  eth1   eth0    anywhere   anywhere \
					state RELATED,ESTABLISHED
 658K   40M ACCEPT     all  --  eth0   eth1    anywhere   anywhere
    0     0 LOG        all  --  any    any     anywhere   anywhere \
					LOG level warning

Chain OUTPUT (policy ACCEPT 2875K packets, 1508M bytes)
 pkts bytes target     prot opt in     out     source     destination

Chain reject_func (0 references)
 pkts bytes target     prot opt in     out     source     destinat
</screen>
</para>

</step>

<step performance="required">
<para>
Führen Sie auf Ihrer Unix Box den Befehl <command>smbclient -L BIGSERVER</command> aus.
Sie sollten eine Liste der verfügbaren Freigaben erhalten.
</para>

<para>
Sollten Sie ein Meldung <quote>Bad password</quote> erhalten, so dürfte
es sich um einen falschen Eintrag bei <parameter>hosts allow</parameter>,
<parameter>hosts deny</parameter> oder <parameter>valid users</parameter>
in Ihrer &smb.conf; handeln oder der guest account ist nicht gültig.

Überprüfen Sie mit &testparm; Ihren guest account und entfernen Sie
testweise alle <parameter>hosts allow</parameter>, <parameter>hosts
deny</parameter>, <parameter>valid users</parameter> oder
<parameter>invalid users</parameter> Einträge.
</para>

<para>
Erhalten Sie eine Meldung <quote><errorname>connection refused</errorname></quote>, dann 
läuft der <command>smbd</command> Prozess nicht.
Haben Sie diesen in <filename>inetd.conf</filename> eingetragen, so
stimmt evtl. dieser Eintrag nicht.
Haben Sie diesen als Dämon installiert, überprüfen Sie mit
<command>netstat -a</command> ob dieser gestartet ist und das 
der netbios-ssn Port den Status LISTEN hat.
</para>

<note><para>
<indexterm><primary>inetd</primary></indexterm>
<indexterm><primary>xinetd</primary><see>inetd</see></indexterm>
Einige UNIX/Linux System verwenden <command>xinetd</command> anstelle
von <command>inetd</command>. Lesen Sie in Ihrer System Dokumentation
die Infos über die entsprechende Implementation Ihres Netzwerk Super
Dämon nach.
</para></note>

<para>
Erhalten Sie eine Meldung <quote><errorname>session request
failed</errorname></quote>, dann lehnt der Server eine Verbingung ab.
Lautet die Info <quote>Your server software is being unfriendly</quote>,
dann könnten Sie wahrscheinlich einen falschen Startparameter für
&smbd; angegeben haben oder es besteht ein ähnliches grundsätzliches
Problem beim starten von &smbd;.

Testen Sie mittels &testparm; Ihre Config Datei (&smb.conf;) 
auf Syntax Fehler und dass die diversen Log und Lock Verzeichnisse von
Samba vorhanden sind.
</para>

<para>
Es gibt eine Menge von Gründen warum smbd eine Verbindung ablehnt oder
verweigert. Die häufigsten Gründe dürften bei folgenden Einträgen in der
&smb.conf; liegen <link linkend="modif1"/>.
</para>


<para>
<smbconfexample id="modif1">
	<title>Konfiguration für erlaubte Verbindungen eines bestimmten Subnetzes</title>
<smbconfsection>[globals]</smbconfsection>
<member>...</member>
<smbconfoption><name>hosts deny</name><value>ALL</value></smbconfoption>
<smbconfoption><name>hosts allow</name><value>xxx.xxx.xxx.xxx/yy</value></smbconfoption>
<smbconfoption><name>interfaces</name><value>eth0</value></smbconfoption>
<smbconfoption><name>bind interfaces only</name><value>Yes</value></smbconfoption>
<member>...</member>
</smbconfexample>
</para>

<para>
Im obigen Beispiel werden keinerlei Verbindungsanforderungen erlaubt, da
diese durch die Adresse des Loopback Devices 127.0.0.1 ersetzt werden.
Um das Problem zu lösen ändern Sie die folgenden Zeilen in <link linkend="modif2"/>
</para>

<para>
<smbconfexample id="modif2">
	<title>Konfiguration für erlaubte Verbindungen eines bestimmten Subnetzes und vom localhost</title>
<smbconfsection>[globals]</smbconfsection>
<member>...</member>
<smbconfoption><name>hosts deny</name><value>ALL</value></smbconfoption>
<smbconfoption><name>hosts allow</name><value>xxx.xxx.xxx.xxx/yy 127.</value></smbconfoption>
<smbconfoption><name>interfaces</name><value>eth0 lo</value></smbconfoption>
<member>...</member>
</smbconfexample>
</para>

<para>
<indexterm><primary>inetd</primary></indexterm>
Eine weitere oft vorkommende Ursache dieser 2 Fehlermeldungen ist ein
bereits laufender <indexterm><primary>smbclient</primary></indexterm> an
port <constant>139</constant>, etwa ein durch <application>inetd</application> 
gestarteter Samba Dämon &smbd; oder etwas vergleichbares wie 
Digital's Pathworks. Überprüfen Sie daher vor dem Start von &smbd; als
Dämon &smbmdash; Ihre <filename>inetd.conf</filename> um eine Menge Frustration zu
vermeiden.
</para>

<para>
Eine weitere mögliche Ursache für ein scheitern dieses Test's besteht
darin, dass die Subnetz Maske und/oder die Broadcast Adresse nicht
korrekt ist. Bitte überprüfen Sie daher die korrekte Broadcast/Subnetz
Maske Ihres Netzwerkinterfaces und dass Samba diese Einstellungen in der
<filename>log.nmbd</filename> Datei bestätigt.
</para>

</step>

<step performance="required">

<para>
Führen Sie den Befehl <command>nmblookup -B BIGSERVER __SAMBA__</command> aus.
Sie sollten die IP Adresse Ihres Samba Servers gemeldet bekommen.
</para>

<para>
Wenn nicht, ist nmbd nicht korrekt installiert. Überprüfen Sie Ihre
<filename>inetd.conf</filename> wenn er durch inetd gestartet wird, oder
ob er als Dämon läuft und an udp Port 137 lauscht.
</para>

<para>
Ein häufiges Problem sind inetd Implementationen welche nicht mehrere
Parameter an der Kommandozeile verarbeiten können.
Ist das bei Ihnen der Fall erstellen Sie ein einzeiliges Skript mit den
richtigen Parametern und starten Sie dieses durch inetd.
</para>

</step>

<step performance="required">

<para>
Starten Sie den Befehl: <command>nmblookup -B ACLIENT `*'</command>
</para>

<para>
Sie sollten die IP Adresse Ihres PC's erhalten. Wenn nicht, ist an Ihrem
PC die Software nicht richtig installiert, konfiguriert, nicht
gestartet oder Sie haben den Namen des PC's falsch eingegeben.
</para>

<para>
Sollte ACLIENT keine DNS Namensauflösung verwenden, dann benutzen Sie
die IP Adresse des Clients für den oben genannten Test.
</para>

</step>

<step performance="required">

<para>
Starten Sie den Befehl: <command>nmblookup -d 2 '*'</command>
</para>

<para>
Dieses mal versuchen wir das selbe wie im vorherigen Test, verwenden
aber einen Broadcast über die default Broadcast Adresse. Es sollten
mehrere NetBios/TCP/IP Rechner im Netzwerk antworten obwohl Samba nicht
alle Anworten in der kurzen Zeit erwischen kann. Sie sollten folgende
Meldunge von diversen Hosts sehen: <quote><errorname>got a positive name query response</errorname></quote>
</para>

<para>
Sollten hier nicht die gleichen Ergebnisse wie im vorangegangenen Test
erscheinen, dann erkennt nmblookup über seinen Automatismus nicht die
korrekte Broadcast Adresse.
In diesem Fall sollten Sie mit manuellen Eingriffen für die IP Adresse,
Broadcast und Netzwerkmaske in &smb.conf; bei der
<smbconfoption><name>interfaces</name></smbconfoption> Option experimentieren.
</para>

<para>
Sind Ihr PC und Server in verschieden Subnetzen benötigen Sie die
<option>-B</option> Option um die Broadcast Adresse des PC's Netzwerkes zu
benutzen.
</para>

<para>
Dieser Test kann möglicherweise fehlschlagen wenn Ihre Subnetzwerk Maske
und Broadcast Adresse nicht korrekt sind. (Siehe vorherige Anmerkungen zu TEST 3).
</para>

</step>

<step performance="required">


<para>
<indexterm><primary>smbclient</primary></indexterm>
Führen Sie folgenden Befehl aus:  <command>smbclient //BIGSERVER/TMP</command>.
Sie sollten nach einem Password gefragt werden. Verwenden Sie das Password
Ihres aktuellen Accounts auf der Unix Box. Möchten Sie den Test mit
einem anderen Account durchführen fügen Sie die <option>-U accountname</option>
Option an das Ende des Befehls hinzu.
Als Beispiel, <command>smbclient //bigserver/tmp -Ujohndoe</command>.
</para>

<note><para>
Es ist folgendermaßen möglich das Passwort zusammen mit dem 
Benutzernamen zu vewenden: <command>smbclient //bigserver/tmp -Ujohndoe%secret</command>.
</para></note>

<para>
Wenn Sie das Passwort eingegeben haben erhalten Sie die
<prompt>smb></prompt> Eingabeauforderung. Wenn nicht beachten Sie die
Fehlermeldung. Steht dort <quote><errorname>invalid network name</errorname></quote> 
dann wurde die Freigabe <smbconfsection>tmp</smbconfsection> nicht korrekt 
in der &smb.conf; eingetragen.
</para>

<para>
Steht dort <quote><errorname>bad password</errorname></quote>, dann
könnte es folgende Ursachen haben:
</para>

<orderedlist>
<listitem>
	<para>
	Sie verwenden shadow Passwörter (oder ein anderes Passwort
	System), haben aber keinen Support dafür in &smbd;
	einkompiliert.
	</para>
</listitem>

<listitem>
	<para>
	Ihr <smbconfoption><name>valid users</name></smbconfoption>
	Eintrag ist nicht korrekt.
	</para>
</listitem>

<listitem>
	<para>
	Sie verwenden Groß/Kleinschreibung im Passwort und haben die
	<smbconfoption><name>password level</name></smbconfoption>
	Option nicht dementsprechend angepasst.
	</para>
</listitem>

<listitem>
	<para>
	Der <smbconfoption><name>path</name></smbconfoption> Eintrag in
	&smb.conf; ist falsch. Überprüfen Sie dies mittels &testparm;.
	</para>
</listitem>

<listitem>
	<para>
	Sie haben die Passwortverschlüsselung aktiviert aber keine Unix
	zu Samba Benutzer zugeordnet/gemappt.
	Starten Sie: <command>smbpasswd -a username</command>.
	</para>
</listitem>
</orderedlist>

<para>
Nachdem Sie verbunden sind sollte es Ihnen möglich sein die Befehle
<command>dir</command>, <command>get</command>,<command>put</command>
und so weiter aufzurufen. Näheres erfahren Sie durch <command>help command</command>.
Sie sollten besonders die Anzeige über den freien Festplatten Platz mittels
<command>dir</command> überprüfen.
</para>

</step>

<step performance="required">

<para>
Führen Sie auf Ihrem PC in einer Dos Eingabeaufforderung/Fenster den Befehl <command>net view \\BIGSERVER</command> aus.
Sie sollten eine Liste der verfügbaren Freigaben Ihres Servers erhalten.
</para>

<para>
Erhalten Sie eine Meldung in der Art <quote><errorname>network name not
found</errorname></quote>, dann funktioniert Ihre netbios
Namensauflösung nicht. Das ist überlicherweise ein Problem mit
<command>nmbd</command>. Um das zu beheben führen Sie eine der
folgenden Möglichkeiten durch:
</para>

<orderedlist>
<listitem><para>
	Korrigieren Sie die &nmbd; Installation.
</para></listitem>

<listitem><para>
	Fügen Sie die IP Adresse des BIGSERVER zu den Einträgen der
	<command>wins server</command> in die Erweiterte TCP/IP
	Konfiguration ihres PC ein.
</para></listitem>

<listitem><para>
	Aktivieren Sie die Windows Namensauflösung über DNS in der
	Erweiterten Konfiguration des TCP/IP Setups Ihres PC.
</para></listitem>

<listitem><para>
	Fügen Sie den Eintrag BIGSERVER zu Ihrer lmhosts Datei auf dem
	PC hinzu.
</para></listitem>
</orderedlist>

<para>
Erhalten Sie die Meldung <quote><errorname>invalid network name</errorname></quote> 
oder <quote><errorname>bad password error</errorname></quote>,
dann führen Sie die selben Maßnahmen wie für die vorherigen
<command>smbclient -L</command> Test's durch.
Achten Sie im Besonderen darauf ob die Einträge in <command>hosts allow</command> 
richtig sind. (siehe man Hilfeseiten).
</para>

<para>
Vergessen Sie bitte nicht, dass die Verbindungsanforderung von Ihrem PC
zum Sambaserver immer mit dem aktuellen Benutzername Ihres angemeldeten
Windowsbenutzer durchgeführt wird.
Sie müssen sicherstellen, dass genau dieser Benutzeraccount mit dem
selben Kennwort auch auf Ihrem Sambaserver existiert.
</para>

<para>
Erhalten Sie eine Meldung in der Art <quote><errorname>specified computer is not receiving requests</errorname></quote>
, dann bedeutet dies vermutlich dass der Computer nicht über TCP angesprochen werden
kann. Wenn Ihr Computer TCP Wrapper einsetzt fügen Sie für den Client
(oder Subnetz, usw.) einen Eintrag in die Datei <filename>hosts.allow</filename> hinzu.
</para>

</step>

<step performance="required">

<para>
Starten Sie den Befehl: <command>net use x: \\BIGSERVER\TMP</command>
Sie sollten nach einem Passwort gefragt werden und nach dessen Eingabe
eine Meldung <computeroutput>command completed successfully</computeroutput> erhalten. 
Sollte das nicht der Fall sein ist Ihr PC nicht
korrekt installiert oder die Datei &smb.conf; ist nicht in Ordnung.
Stellen Sie sicher das die Einträge in <parameter>hosts allow</parameter> korrekt sind 
und die restlichen Einträge &smb.conf; stimmen.
</para>

<para>
Es ist auch möglich dass der Server nicht erkennen kann unter welchem
Namen Sie sich verbinden.
Um das Problem zu erkennen fügen Sie die Zeile
<smbconfoption><name>user</name><value>username</value></smbconfoption>
in die <smbconfsection>[tmp]</smbconfsection> Sektion der &smb.conf;
hinzu, wobei <parameter>username</parameter> der Benutzername zum
eingegebenem Passwort sein muss. Wenn dass klappt benötigen Sie die
username mapping Option. 
</para>

<para>
Es ist auch möglich das Ihr Client nur verschlüsselte Passwörter
versendet aber Sie habe den Eintrag <smbconfoption><name>encrypt
passwords</name><value>no</value></smbconfoption> in der &smb.conf;
stehen.
Ändern Sie diesen auf "yes" um das Problem zu beheben.
</para>

</step>

<step performance="required">

<para>
Führen Sie den Befehl <command>nmblookup -M <parameter>testgroup</parameter></command>
aus, wobei <parameter>testgroup</parameter> der Name der Arbeitsgruppe
Ihres Sambaservers und Ihrer Windows PC's ist. Sie sollten die IP
Adresse des Masterbrowsers für diese Arbeitsgruppe erhalten.
</para>

<para>
Wenn nicht, dann ist der Auswahlprozess des Masterbrowsers fehlgeschlagen. 
Warten Sie evtl.  noch ein paar Minuten und versuchen Sie es dann nochmal um zu sehen ob
es nur etwas langsam ist. Klappt es dann immer noch nicht werfen Sie
einen Blick zu den browsing Optionen in der &smb.conf;.
Stellen Sie sicher das Sie <smbconfoption><name>preferred master</name><value>yes</value></smbconfoption>
eingetragen haben um beim starten eine Auswahl des Masterbrowser
durchgeführt wird.
</para>

</step>

<step performance="required">

<para>
Durchsuchen Sie Ihre Netzwerkumgebung mit Ihrem Windows Explorer/Dateimanager.
Ihr Sambaserver sollte in der Netzwerkumgebung unter Ihrer lokalen Arbeitsgruppe
(oder welche Sie in der &smb.conf; eingetragen habe) erscheinen.
Es müsste Ihnen möglich sein durch einen Doppelklick auf den Namen des
Servers die Liste der Freigaben zu erhalten.
Erhalten Sie eine Fehlermeldung <quote>invalid password</quote> dann
verwenden Sie möglicherweiße Windows NT denn dass öffnet keinen Server der
keine verschlüsselten Passwörter unterstützt und der sich im User Level Security
Mode befindet.
In diesem Fall tragen Sie 
<smbconfoption><name>security</name><value>server</value></smbconfoption>
und 
<smbconfoption><name>password server</name><value>Windows_NT_Machine</value></smbconfoption>
in Ihre &smb.conf; ein oder stellen Sie sicher das 
<smbconfoption><name>encrypt passwords</name></smbconfoption> auf
<quote>yes</quote> steht.
</para>

</step>
</procedure>
</sect1>

</chapter>
