<html><head><meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1"><title>Chapter 7. Domänen-Mitgliedschaft</title><link rel="stylesheet" href="samba.css" type="text/css"><meta name="generator" content="DocBook XSL Stylesheets V1.61.3"><link rel="home" href="index.html" title="Samba HOWTO Collection"><link rel="up" href="type.html" title="Part II. Basiswissen zur Server-Konfiguration"><link rel="previous" href="samba-bdc.html" title="Chapter 6. Backup Domänen-Verwaltung"><link rel="next" href="StandAloneServer.html" title="Chapter 8. Stand-alone-Server"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">Chapter 7. Domänen-Mitgliedschaft</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="samba-bdc.html">Prev</a> </td><th width="60%" align="center">Part II. Basiswissen zur Server-Konfiguration</th><td width="20%" align="right"> <a accesskey="n" href="StandAloneServer.html">Next</a></td></tr></table><hr></div><div class="chapter" lang="en"><div class="titlepage"><div><div><h2 class="title"><a name="domain-member"></a>Chapter 7. Domänen-Mitgliedschaft</h2></div><div><div class="author"><h3 class="author"><span class="firstname">John</span> <span class="othername">H.</span> <span class="surname">Terpstra</span></h3><div class="affiliation"><span class="orgname">Samba Team<br></span><div class="address"><p><tt class="email">&lt;<a href="mailto:jht@samba.org">jht@samba.org</a>&gt;</tt></p></div></div></div></div><div><div class="author"><h3 class="author"><span class="firstname">Jeremy</span> <span class="surname">Allison</span></h3><div class="affiliation"><span class="orgname">Samba Team<br></span><div class="address"><p><tt class="email">&lt;<a href="mailto:jra@samba.org">jra@samba.org</a>&gt;</tt></p></div></div></div></div><div><div class="author"><h3 class="author"><span class="firstname">Gerald</span> <span class="othername">(Jerry)</span> <span class="surname">Carter</span></h3><div class="affiliation"><span class="orgname">Samba Team<br></span><div class="address"><p><tt class="email">&lt;<a href="mailto:jerry@samba.org">jerry@samba.org</a>&gt;</tt></p></div></div></div></div><div><div class="author"><h3 class="author"><span class="firstname">Andrew</span> <span class="surname">Tridgell</span></h3><div class="affiliation"><span class="orgname">Samba Team<br></span><div class="address"><p><tt class="email">&lt;<a href="mailto:tridge@samba.org">tridge@samba.org</a>&gt;</tt></p></div></div></div></div><div><div class="author"><h3 class="author"><span class="firstname">Jelmer</span> <span class="othername">R.</span> <span class="surname">Vernooij</span></h3><div class="affiliation"><span class="orgname">The Samba Team<br></span><div class="address"><p><tt class="email">&lt;<a href="mailto:jelmer@samba.org">jelmer@samba.org</a>&gt;</tt></p></div></div></div></div><div><div class="author"><h3 class="author"><span class="firstname">Guenther</span> <span class="surname">Deschner</span></h3><span class="contrib">LDAP updates</span><div class="affiliation"><span class="orgname">SuSE<br></span><div class="address"><p><tt class="email">&lt;<a href="mailto:gd@suse.de">gd@suse.de</a>&gt;</tt></p></div></div></div></div><div><div class="author"><h3 class="author"><span class="firstname">Stefan</span> <span class="othername">G.</span> <span class="surname">Weichinger</span></h3><span class="contrib">Deutsche Übersetzung</span></div></div></div><div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><a href="domain-member.html#id2899847">Eigenschaften und Vorzüge</a></dt><dt><a href="domain-member.html#machine-trust-accounts">MS Windows Workstation/Server Maschinen-Vertrauens-Konten</a></dt><dd><dl><dt><a href="domain-member.html#id2900273">Manuelles Anlegen von Maschinen-Vertrauens-Konten</a></dt><dt><a href="domain-member.html#id2900615">Das Verwalten von Domänen-Maschinen-Konten mittels des Server Managers</a></dt><dt><a href="domain-member.html#id2900905">"On-the-Fly" Anlegen von Maschinen-Konten</a></dt><dt><a href="domain-member.html#id2901001">Eine MS Windows Workstation oder einen MS Windows Server zum Domänen-Mitglied machen</a></dt></dl></dd><dt><a href="domain-member.html#domain-member-server">Domänen-Mitglieds-Server</a></dt><dd><dl><dt><a href="domain-member.html#id2901296">Sich mit Samba-3 einer NT4-Domäne anschliessen</a></dt><dt><a href="domain-member.html#id2901878">Warum ist dies besser als security = server?</a></dt></dl></dd><dt><a href="domain-member.html#ads-member">Samba ADS Domänen-Mitgliedschaft</a></dt><dd><dl><dt><a href="domain-member.html#id2902128">Das Konfigurieren von smb.conf</a></dt><dt><a href="domain-member.html#id2902266">Configure /etc/krb5.conf</a></dt><dt><a href="domain-member.html#ads-create-machine-account">Create the Computer Account</a></dt><dt><a href="domain-member.html#ads-test-server">Testing Server Setup</a></dt><dt><a href="domain-member.html#ads-test-smbclient">Testing with smbclient</a></dt><dt><a href="domain-member.html#id2902867">Notes</a></dt></dl></dd><dt><a href="domain-member.html#id2902904">Sharing User ID Mappings between Samba Domain Members</a></dt><dt><a href="domain-member.html#id2903036">Common Errors</a></dt><dd><dl><dt><a href="domain-member.html#id2903065">Cannot Add Machine Back to Domain</a></dt><dt><a href="domain-member.html#id2903099">Adding Machine to Domain Fails</a></dt><dt><a href="domain-member.html#id2903264">I Can't Join a Windows 2003 PDC</a></dt></dl></dd></dl></div><p>
Domänen-Mitgliedschaft ist ein Thema von regem Interesse. Samba muß fähig
sein, als ein Mitglieds-Server in einem Microsoft-Domänen-Sicherheits-Kontext
teilzunehmen, und Samba muß dazu fähig sein, Maschinen-Vertrauens-Konten für
Domänen-Maschinen anzubieten, anderenfalls wäre es keine erwägenswerte
Option für viele Anwender.
</p><p>
Dieses Kapitel umfaßt Hintergrund-Informationen zur Domänen-Mitgliedschaft,
der dazu notwendigen Samba-Konfiguration, und MS-Windows-Client-Prozeduren
zum Beitreten zu einer Domäne. Warum dies notwendig ist? Weil beide Bereiche solche sind,
in denen sowohl in der MS-Windows-Netzwerk-Welt, wie auch im Speziellen in der UNIX/Linux-
Netzwerk- und Administrations-Welt, ein bemerkenswertes Level an Uninformiertheit,
falschem Verständnis und fehlendem Wissen existiert. Es ist zu hoffen, daß dieses Kapitel
die Lücken füllt.
</p><div class="sect1" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="id2899847"></a>Eigenschaften und Vorzüge</h2></div></div><div></div></div><p>
MS-Windows-Workstations und -Server, die an Domänen-Sicherheit teilhaben wollen, müssen zu
Domänen-Mitgliedern gemacht werden. Das Teilnehmen an Domänen-Sicherheit wird oft
<span class="emphasis"><em>Single Sign On</em></span> oder kurz <span class="acronym">SSO</span> genannt.
Dieses Kapitel beschreibt den Prozeß, der durchgeführt werden muß, um eine Workstation
(oder einen anderen Server  sei es ein <span class="application">MS Windows NT4 / 200x</span>-
Server) oder einen Samba-Server zu einem Mitglied in einem Microsoft-Domänen-Sicherheits-Kontext
zu machen.
</p><p>
<a class="indexterm" name="id2899895"></a>
Samba-3 kann sich einer MS-Windows-artigen Domäne als nativer Mitglieds-Server anschliessen,
oder einem Samba-kontrollierten Netzwerk. Domänen-Mitgliedschaft hat viele Vorteile: 
</p><div class="itemizedlist"><ul type="disc"><li><p>
<a class="indexterm" name="id2899923"></a>
	MS-Windows-Workstation-Benutzer erhalten die Vorteile von SSO.
	</p></li><li><p>
	Zugriffsrechte von Domänen-Benutzern und Datei-Benutzer/Zugriffs-Kontrollen
	können über die einzelne "Domain Security Account Manager" (SAM) Datenbank
	gesetzt werden (arbeitet genauso mit Domänen-Mitglieds-Serveren wie auch mit
	MS-Windows-Workstations, die Domänen-Mitglieder sind).
	</p></li><li><p>
	Nur <span class="application">MS Windows NT4/200x/XP Professional</span>
	Workstations, die Domänen-Mitglieder sind, können Netzwerk-Anmeldedienste benutzen.
	</p></li><li><p>
	Domänen-Mitglieds-Workstations können durch die Verwendung von Policy-Dateien 
	(<tt class="filename">NTConfig.POL</tt>) und Desktop-Profilen besser
	kontrolliert werden.
	</p></li><li><p>
	Durch die Verwendung von Anmelde-Skripts können Benutzer transparenten Zugriff auf
	Netz-Anwendungen erhalten, die auf Applikations-Servern laufen.
	</p></li><li><p>
	Netzwerk-Administratoren erhalten bessere Möglichkeiten zum Management von
	Applikations- und Benutzer-Zugriffen, da kein Bedarf mehr besteht, Benutzer-Konten
	auf irgendeinem Netzwerk-Client oder -Server zu verwalten, außer in der zentralen
	Domänen-Datenbank (entweder NT4/Samba-SAM-artig, eine NT4-Domäne, die durch ein
	LDAP-Backend ergänzt wird, oder eine Active Directory Infrastruktur).
	</p></li></ul></div></div><div class="sect1" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="machine-trust-accounts"></a>MS Windows Workstation/Server Maschinen-Vertrauens-Konten</h2></div></div><div></div></div><p>
<a class="indexterm" name="id2900028"></a>
Ein Maschinen-Vertrauens-Konto ist ein Konto, das dazu verwendet wird, eine Client-Maschine
(und nicht einen Benutzer) am Domänen-Controller zu authentifizieren. In der Windows-
Terminologie ist dies als &#8220;<span class="quote">Maschinen-Konto</span>&#8221; bekannt. Der Zweck des 
Maschinen-Kontos ist es, zu verhindern, daß ein schurkischer Benutzer mit einem 
Domänen-Controller konspiriert,
um Zugriff auf eine Domänen-Mitglieds-Workstation zu erhalten.
</p><p>
Das Passwort eines Maschinen-Vertrauens-Kontos fungiert als "gemeinsames Geheimnis" für
sichere Kommunikation mit dem Domänen-Controller. Dies ist ein Sicherheits-Feature, um eine
nicht authorisierte Maschine mit dem selben NetBIOS-Namen davon abzuhalten, sich der Domäne
anzuschliessen und Zugriff auf Benutzer/Gruppen-Konten der Domäne zu erhalten.
Windows NT/200x/XP Professional-Clients nutzen Maschinen-Vertrauens-Konten, aber
Windows 9x/Me/XP Home Clients tun das nicht. Daher ist ein Windows 9x/Me/XP Home Client nie
ein vollwertiges Domänen-Mitglied, da er kein Maschinen-Vertrauens-Konto besitzt, und daher
kein "gemeinsames Geheimnis" mit dem Domänen-Controller teilt.
</p><p>
Ein Windows NT4 PDC speichert jedes Maschinen-Vertrauens-Konto in der Windows-Registrierung.
Die Einführung von MS Windows 2000 brachte auch die Einführung des Active Directory, dem
neuen Repository für Maschinen-Vertrauens-Konten. Ein Samba-PDC speichert jedoch jedes
Maschinen-Vertrauens-Konto in zwei Teilen, wie folgt:

</p><div class="itemizedlist"><ul type="disc"><li><p>
	Ein Domänen-Sicherheits-Konto (gespeichert in dem
	<a class="indexterm" name="id2900113"></a><i class="parameter"><tt>passdb backend</tt></i>, das in der Datei <tt class="filename">smb.conf</tt>
	konfiguriert wurde. Die exakte Form der gespeicherten Konten-Information ist vom
	Typ des gewählten Backends abhängig.
	</p><p>
	Das ältere Format dieser Daten ist die Datenbank <tt class="filename">smbpasswd</tt>, die
	die UNIX Login-ID, den UNIX user identifier (UID), die LanMan- und die verschlüsselten
	NT-Passwörter enthält. Es gibt noch weitere Informationen zu dieser Datei, die uns jedoch
	an dieser Stelle nicht interessiert.
	</p><p>
	Die zwei neueren Datenbank-Typen heissen ldapsam und tdbsam. Beide speichern bei weitem
	mehr Daten als das ältere <tt class="filename">smbpasswd</tt>. Die zusätzliche Information
	ermöglicht das Implementieren neuer Funktionen für Benutzer-Konten.	
	</p></li><li><p>
	Ein entsprechendes UNIX-Konto, meist in <tt class="filename">/etc/passwd</tt> gespeichert.
	Es wird daran gearbeitet, eine vereinfachte Betriebsart zu erlauben, die keine
	UNIX-Konten erfordert, jedoch wird dies kein Feature der ersten Samba-3-Releases sein.	
	</p></li></ul></div><p>
</p><p>
<a class="indexterm" name="id2900203"></a>
Es gibt drei Möglichkeiten, Maschinen-Vertrauens-Konten anzulegen:
</p><div class="itemizedlist"><ul type="disc"><li><p>
	Manuelles Anlegen auf der UNIX/Linux-Befehlszeile.
	Hier werden sowohl das Samba-, wie auch das zugehörige UNIX-Konto von Hand angelegt.
	</p></li><li><p>
	<a class="indexterm" name="id2900236"></a>
	Das Verwenden vom MS Windows NT4 Server Manager, entweder auf einem
	NT4 Domain Member Server, oder unter Verwendung des Nexus-Toolkits, das auf der
	Microsoft Website verfügbar ist. Dieses Tool kann von jeder MS Windows Maschine aus
	verwendet werden, solange der Benutzer als Administrator angemeldet ist.
	</p></li><li><p>
	&#8220;<span class="quote">On-the-fly</span>&#8221; anlegen. Das Samba Maschinen-Vertrauens-Konto wird
	automatisch von Samba angelegt, wenn sich der Client der Domäne anschließt.
	(Aus Sicherheitsgründen ist dies die empfohlene Methode.) Das zugehörige
	UNIX-Konto kann automatisch oder manuell angelegt werden.
	</p></li></ul></div><div class="sect2" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="id2900273"></a>Manuelles Anlegen von Maschinen-Vertrauens-Konten</h3></div></div><div></div></div><p>
Der erste Schritt beim manuellen Anlegen eines Maschinen-Vertrauens-Kontos ist das manuelle
Anlegen des zugehörigen UNIX-Kontos in der Datei <tt class="filename">/etc/passwd</tt>.
Dies kann mittels <b class="command">vipw</b> oder einem anderen &#8220;<span class="quote">add user</span>&#8221;-Befehl
geschehen, der normalerweise zum Anlegen von UNIX-Benutzern verwendet wird. Hier ein Beispiel
für einen Linux-basierenden Samba-Server:
</p><p>
<a class="indexterm" name="id2900315"></a>
<a class="indexterm" name="id2900323"></a>
</p><pre class="screen">
<tt class="prompt">root# </tt><b class="userinput"><tt>/usr/sbin/useradd -g machines -d /dev/null -c <i class="replaceable"><tt>"machine nickname"</tt></i> \
   -s /bin/false <i class="replaceable"><tt>machine_name</tt></i>$ </tt></b>

<tt class="prompt">root# </tt><b class="userinput"><tt>passwd -l <i class="replaceable"><tt>machine_name</tt></i>$</tt></b>
</pre><p>
</p><p>In obigem Beispiel gibt es eine System-Gruppe &#8220;<span class="quote">machines</span>&#8221;, welche als primäre Gruppe
für alle Maschinen-Konten verwendet wird. In den folgenden Beispielen hat die Gruppe
&#8220;<span class="quote">machines</span>&#8221; eine numerische GID von 100.</p><p>
<a class="indexterm" name="id2900399"></a>
Auf *BSD-Systemen kann dies mit dem Utility <b class="command">chpass</b> geschehen:
</p><p>
</p><pre class="screen">
<tt class="prompt">root# </tt><b class="userinput"><tt>chpass -a \
'<i class="replaceable"><tt>machine_name</tt></i>$:*:101:100::0:0:Windows <i class="replaceable"><tt>machine_name</tt></i>:/dev/null:/sbin/nologin'</tt></b>
</pre><p>
</p><p>
Der Eintrag in <tt class="filename">/etc/passwd</tt> wird den Maschinen-Namen enthalten, mit einem
angefügten &#8220;<span class="quote">$</span>&#8221;, ohne Passwort, mit einer Null-Shell und ohne home-Verzeichnis.
Zum Beispiel würde eine Maschine namens &#8220;<span class="quote">doppy</span>&#8221; diesen Eintrag haben:
</p><pre class="programlisting">
doppy$:x:505:100:<i class="replaceable"><tt>machine_nickname</tt></i>:/dev/null:/bin/false
</pre><p>
In obigem Beispiel kann <i class="replaceable"><tt>machine_nickname</tt></i> eine beliebige Beschreibung
des Clients sein, z.B. RechnerSekretariat.
<i class="replaceable"><tt>machine_name</tt></i> muß definitiv der NetBIOS-Namen des Clients sein, der der
Domäne angeschlossen werden soll. Das Zeichen &#8220;<span class="quote">$</span>&#8221; muß an den NetBIOS-Namen des Clients
angefügt werden, oder Samba wird dieses Konto nicht als Maschinen-Vertrauens-Konto erkennen.
</p><p>
Jetzt, wo das zugehörige UNIX-Konto angelegt wurde, ist der nächste Schritt das Anlegen
des Samba-Kontos für den Client, mit dem wohlbekannten ursprünglichen Passwort des
Maschinen-Vertrauens-Kontos. Dies kann mit dem Befehl <b class="command">smbpasswd</b> geschehen,
wie hier gezeigt:
</p><p>
</p><pre class="screen">
<tt class="prompt">root# </tt><b class="userinput"><tt>smbpasswd -a -m <i class="replaceable"><tt>machine_name</tt></i></tt></b>
</pre><p>
</p><p>
wobei <i class="replaceable"><tt>machine_name</tt></i> der NetBIOS-Namen der Maschine ist.
Die RID des neuen Maschinen-Kontos wird aus der UID des zugehörigen UNIX-Kontos generiert.
</p><div class="warning" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Schliessen Sie den Client unverzüglich der Domäne an</h3><p>
Das manuelle Anlegen eines Maschinen-Vertrauens-Kontos mit dieser Methode ist gleichwertig
zum Anlegen eines Maschinen-Vertrauens-Kontos auf einem Windows NT PDC mittels des
<a class="indexterm" name="id2900588"></a><span class="application">Server Manager</span>.
Vom Zeitpunkt des Anlegens des Kontos bis zum Anschliessen des Clients an die Domäne und des
Ändern des Passworts ist Ihre Domäne verletzlich gegenüber einem Eindringling, der sich mittels
einer Maschine mit dem gleichen NetBIOS-Namen der Domäne anschliesst. Ein PDC vertraut
Mitgliedern der Domäne und wird ein grosses Maß an Benutzer-Informationen an solche Clients
weitergeben. Sie wurden gewarnt!
</p></div></div><div class="sect2" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="id2900615"></a>Das Verwalten von Domänen-Maschinen-Konten mittels des Server Managers</h3></div></div><div></div></div><p>
Ein funktionierendes <a class="indexterm" name="id2900628"></a><i class="parameter"><tt>add machine script</tt></i>-Skript
ist essentiell notwendig, um Maschinen-Vertrauens-Konten automatisch anlegen zu können. Dies
gilt unabhängig davon, ob man automatisches Anlegen der Konten verwendet oder dern
NT4 Domain Server Manager.
</p><p>
<a class="indexterm" name="id2900658"></a>
Wenn die Maschine, von der aus Sie versuchen, die Domäne zu verwalten, eine 
<span class="application">MS Windows NT4 Workstation oder MS Windows 200x/XP Professional</span> ist,
ist das zu wählende Werkzeug das Package namens <b class="command">SRVTOOLS.EXE</b>.
Wenn es im Zielverzeichnis ausgeführt wird, entpackt es <b class="command">SrvMgr.exe</b> und
<b class="command">UsrMgr.exe</b>, beides sind Domänen-Management-Werkzeuge für 
MS Windows NT4 Workstation.
</p><p>
<a class="indexterm" name="id2900707"></a>
Wenn Ihre Workstation ein Produkt der <span class="application">Microsoft Windows 9x/Me</span>-Familie ist,
sollten Sie das Package <b class="command">Nexus.exe</b> von der Microsoft Website laden.
Auch dies wird dieselben Tools entpacken, aber eben für die Windows 9x/Me-Plattformen.
</p><p>
Weitere Informationen zu diesen Tools kann von folgenden Stellen bezogen werden:
</p><p>
</p><table class="simplelist" border="0" summary="Simple list"><tr><td><a href="http://support.microsoft.com/default.aspx?scid=kb;en-us;173673" target="_top">http://support.microsoft.com/default.aspx?scid=kb;en-us;173673</a></td></tr><tr><td><a href="http://support.microsoft.com/default.aspx?scid=kb;en-us;172540" target="_top">http://support.microsoft.com/default.aspx?scid=kb;en-us;172540</a></td></tr></table><p>
</p><p>
Starten Sie <b class="command">srvmgr.exe</b> (Server Manager für Domänen) und folgen Sie diesen Schritten:
</p><div class="procedure"><p class="title"><b>Procedure 7.1. Verwaltung von Maschinen-Konten mittels Server Manager</b></p><ol type="1"><li><p>
	Wählen Sie den Eintrag <span class="guimenu">Computer</span> aus dem Menü.
	</p></li><li><p>
	Klicken Sie auf <span class="guimenuitem">Select Domain</span>.
	</p></li><li><p>
	Klicken Sie im Panel <span class="guilabel">Select Domain</span> auf den Namen der Domäne, 
	die Sie administrieren wollen, und dann auf <span class="guibutton">OK</span>.
	</p></li><li><p>
	Wählen Sie nochmals das Menu <span class="guimenu">Computer</span>.
	</p></li><li><p>
	Wählen Sie <span class="guimenuitem">Add to Domain</span>.
	</p></li><li><p>
	Klicken Sie den Radio-Button <span class="guilabel">Add NT Workstation of Server</span> 
	in der folgenden Dialogbox, dann geben Sie den Maschinen-Namen im vorgegebenen Feld ein,
	und klicken auf <span class="guibutton">Add</span>.
	</p></li></ol></div></div><div class="sect2" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="id2900905"></a>"On-the-Fly" Anlegen von Maschinen-Konten</h3></div></div><div></div></div><p>
Die zweite (und empfohlene) Art, Maschinenkonten anzulegen, ist, es einfach dem Samba-Server zu
erlauben, diese Konten bei Bedarf anzulegen, wenn der Client der Domäne angeschlossen wird.
</p><p>Da jedes Maschinen-Vertrauens-Konto unter Samba ein zugehöriges UNIX-Konto benötigt,
wird üblicherweise eine Methode zum automatischen Anlegen eines UNIX-Kontos bereitgestellt;
dies erfordert die Konfiguration der Option "add machine script" in der Datei <tt class="filename">smb.conf</tt>.
Diese Methode ist jedoch nicht erforderlich, die benötigten UNIX-Konten können auch händisch
angelegt werden.
</p><p>
Hier ein Beispiel für ein Red Hat Linux System.
</p><table class="simplelist" border="0" summary="Simple list"><tr><td> </td></tr><tr><td><i class="parameter"><tt>[global]</tt></i></td></tr><tr><td># &lt;...Erinnerung an Parameter...&gt;</td></tr><tr><td><i class="parameter"><tt>add machine script = /usr/sbin/useradd -d /dev/null -g 100 \</tt></i></td></tr><tr><td><i class="parameter"><tt>  -s /bin/false -M %u</tt></i></td></tr></table></div><div class="sect2" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="id2901001"></a>Eine MS Windows Workstation oder einen MS Windows Server zum Domänen-Mitglied machen</h3></div></div><div></div></div><p>
Die Vorgehensweise, um eine MS Windows Workstation oder einen MS Windows Server zum Domänen-Mitglied
zu machen, ist abhängig von der Version von Windows.
</p><div class="sect3" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="id2901016"></a>Windows 200x/XP Professional Client</h4></div></div><div></div></div><p>
	Wenn der Benutzer den Client dazu "erwählt", ein Domänen-Mitglied zu werden, fragt
	Windows 200x nach einer Konto/Passwort-Kombination, die dazu berechtigt ist, Maschinen-Konten
	in der Domäne anzulegen. Ein Samba-Administrator-Konto (also ein Samba-Konto, das
	<tt class="constant">root</tt>-Rechte auf dem Samba-Server hat) muß hier verwendet werden;
	der Vorgang wird scheitern, wenn ein normales Benutzerkonto verwendet wird.
	</p><p>
	Aus Sicherheitsgründen sollte das Passwort für dieses Administrator-Konto auf ein anderes
	Passwort gesetzt werden als jenes, das für den Benutzer root in <tt class="filename">/etc/passwd</tt>
	verwendet wird.
	</p><p>
	Der Name des Kontos, das zum Anlegen von Domänenmitglieds-Maschinen-Konten verwendet wird,
	kann etwas beliebiges sein, das der Netzwerk-Administrator wählt. Wenn dieser Name etwas anderes
	als <tt class="constant">root</tt> ist, wird es einfach auf den dem Benutzer
	<tt class="constant">root</tt> zugehörigen Eintrag in der 
	vom Parameter
	<a class="indexterm" name="id2901086"></a><i class="parameter"><tt>username map</tt></i> = /etc/samba/smbusers 
	in der Datei <tt class="filename">smb.conf</tt> bezeichneten Datei "gemappt".
	</p><p>
	Der "Session-Key" des Samba-Administrator-Kontos fungiert als Verschlüsselungs-Schlüssel
	zum Setzen des Passworts für das Maschinen-Vertrauens-Konto. Das Maschinen-Vertrauens-Konto
	wird on-the-fly angelegt, oder aktualisiert, falls es bereits existiert.
	</p></div><div class="sect3" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="id2901125"></a>Windows NT4 Client</h4></div></div><div></div></div><p>
	Wenn das Maschinen-Vertrauens-Konto manuell angelegt wurde, geben Sie im Menu
	"Identification Changes" den Domänen-Namen an, aber aktivieren Sie NICHT die Box
	<span class="guilabel">Create a Computer Account in the Domain</span>. In diesem Fall wird
	das bereits existierende Maschinen-Vertrauens-Konto verwendet, um die Maschine der
	Domäne anzuschliessen.
	</p><p>
	Wenn das Maschinen-Vertrauens-Konto on-the-fly angelegt werden soll, geben Sie im Menu
	"Identification Changes" den Domänen-Namen an, und aktivieren die Box
	<span class="guilabel">Create a Computer Account in the Domain</span>. In diesem Fall wird der Anschluß
	an die Domäne wie oben fortgesetzt, wie oben für Windows 2000 beschrieben (d.h., Sie müssen
	ein Samba-Administrator-Konto angeben, wenn danach verlangt wird).
	</p></div><div class="sect3" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="id2901173"></a>Samba Client</h4></div></div><div></div></div><p>Das Anschliessen eines Samba-Clients an eine Domäne wird in
	<a href="domain-member.html#domain-member-server" title="Domänen-Mitglieds-Server">Domänen-Mitglieds-Server</a> beschrieben.
	</p></div></div></div><div class="sect1" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="domain-member-server"></a>Domänen-Mitglieds-Server</h2></div></div><div></div></div><p>
Diese Server-Betriebsart beinhaltet, daß die Samba-Maschine zum Domänen-Mitglied gemacht wird.
Das bedeutet per Definition, daß jegliche Benutzer-Authentifikation von einem zentral bestimmten
Authentifikations-Regime erfolgen wird. Das Authentifikations-Regime kann von einem NT3/4-artigen
(alte Domänen-Technologie) Server kommen, oder es kann von einem Active Directory Server (ADS)
bereitgestellt werden, der unter MS Windows 2000 oder einem neueren MS Windows läuft.
</p><p>
<span class="emphasis"><em>
Es sollte natürlich klar sein, daß das Authentifikations-Backend selbst ein Server von jeder
Verzeichnis-Dienst-Architektur sein kann, die von Samba unterstützt wird. Es kann LDAP (von
OpenLDAP) sein, oder Sun's iPlanet, ein NetWare Directory Server, und so weiter.
</em></span>
</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3>
Wenn Samba für die Verwendung von LDAP konfiguriert ist, oder eine andere Identitäts-Verwaltung
und/oder einen Verzeichnisdienst, dann ist es Samba, das die Authentifikation von Benutzern und
Maschinen weiter ausführt. Es sollte beachtet werden, daß der LDAP-Server die Authentifikation
nicht anstatt Samba ausführt.
</div><p>
Bitte besuchen Sie <a href="samba-pdc.html" title="Chapter 5. Die Kontrolle über eine Domäne">Domain Control</a> für mehr Informationen darüber,
wie man ein Domänen-Maschinen-Konto anlegt, aber auch darüber, wie man eine Samba-Maschine, die
Domänen-Mitglied ist, dazu befähigt, sich der Domäne anzuschliessen, und deren volles Vertrauen
zu gewinnen ...
</p><div class="sect2" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="id2901296"></a>Sich mit Samba-3 einer NT4-Domäne anschliessen</h3></div></div><div></div></div><p><a href="domain-member.html#assumptions" title="Table 7.1. Annahmen">Die nächste Tabelle</a> enthält eine Liste von Namen, die im Rest dieses Kapitels verwendet wurden.</p><div class="table"><a name="assumptions"></a><p class="title"><b>Table 7.1. Annahmen</b></p><table summary="Annahmen" border="1"><colgroup><col align="right"><col align="left"></colgroup><tbody><tr><td align="right">NetBIOS-Namen:</td><td align="left">SERV1</td></tr><tr><td align="right">Windows 200x/NT Domänen-Namen:</td><td align="left">MITTELERDE</td></tr><tr><td align="right">NetBIOS-Namen des Domänen-PDC:</td><td align="left">DOMPDC</td></tr><tr><td align="right">NetBIOS-Namen der Domänen-BDCs:</td><td align="left">DOMBDC1 und DOMBDC2</td></tr></tbody></table></div><p>
Als erstes müssen Sie Ihre Datei <tt class="filename">smb.conf</tt> editieren, um Samba mitzuteilen, daß es ab jetzt 
Domänen-Sicherheit verwenden soll.
</p><p>
Ändern (oder fügen Sie sie hinzu) Sie die Zeile
<a class="indexterm" name="id2901423"></a><i class="parameter"><tt>security</tt></i> im Abschnitt [global] 
Ihrer <tt class="filename">smb.conf</tt> auf
</p><p>
</p><table class="simplelist" border="0" summary="Simple list"><tr><td><i class="parameter"><tt>security = domain</tt></i></td></tr></table><p>
</p><p>
Als nächstes ändern Sie die Zeile <a class="indexterm" name="id2901468"></a><i class="parameter"><tt>workgroup</tt></i> im
Abschnitt <i class="parameter"><tt>[global]</tt></i> auf
</p><p>
</p><table class="simplelist" border="0" summary="Simple list"><tr><td><i class="parameter"><tt>workgroup = MITTELERDE</tt></i></td></tr></table><p>
</p><p>
Dies ist der Name der Domäne, der wir uns anschliessen.
</p><p>
Sie müssen auch den Parameter <a class="indexterm" name="id2901520"></a><i class="parameter"><tt>encrypt passwords</tt></i> auf
<tt class="constant">yes</tt> setzen, um Ihren Benutzern die Authentifikation am NT-PDC zu ermöglichen.
Dies ist die Standard-Einstellung, falls dieser Parameter nicht gesetzt wird. Es gibt keinen Grund,
diesen Parameter zu setzen, aber wenn er in der Datei <tt class="filename">smb.conf</tt> gesetzt wird, muß er auf
<tt class="constant">Yes</tt> gesetzt werden.
</p><p>
Zuletzt fügen Sie dem Abschnitt [global] die Zeile 
<a class="indexterm" name="id2901569"></a><i class="parameter"><tt>password server</tt></i> hinzu (oder ändern sie), sodaß sie lautet:
</p><p>
</p><table class="simplelist" border="0" summary="Simple list"><tr><td><i class="parameter"><tt>password server = DOMPDC DOMBDC1 DOMBDC2</tt></i></td></tr></table><p>
</p><p>
Dies sind der PDC und die BDCs, die Samba kontaktieren wird, um Benutzer zu authentifizieren.
Samba wird versuchen, jeden dieser Server in der angegebenen Reihenfolge zu kontaktieren, daher
können Sie durch die Reihung der Server die Last auf die einzelnen Domänen-Controller verteilen.
</p><p>
Wenn Sie andererseits wollen, daß smbd automatisch die Liste der zu verwendenden Domänen-Controller
bestimmt, können Sie diese Zeile auf folgendes setzen:
</p><p>
</p><table class="simplelist" border="0" summary="Simple list"><tr><td><i class="parameter"><tt>password server = *</tt></i></td></tr></table><p>
</p><p>
Diese Methode erlaubt es Samba, genau denselben Mechanismus wie NT zu verwenden.
Sie verwendet entweder Namensauflösung, die auf Broadcasts basiert, führt eine WINS-Datenbank-Abfrage
durch, um einen Domänen-Controller zu finden, oder lokalisiert einen Domänen-Controller mittels
DNS-Namensauflösung.
</p><p>
Zum Anschluß an eine Domäne geben Sie diesen Befehl:
</p><p>
</p><pre class="screen">
<tt class="prompt">root# </tt><b class="userinput"><tt>net join -S DOMPDC -U<i class="replaceable"><tt>Administrator%Passwort</tt></i></tt></b>
</pre><p>
</p><p>
Wenn das Argument <tt class="option">-S DOMPDC</tt> nicht angegeben wird, wird der Domänen-Name aus der Datei
<tt class="filename">smb.conf</tt> gelesen.
</p><p>
Die Maschine schließt sich der Domäne DOM an, und der PDC für diese Domäne (die einzige Maschine, die
Schreib-Zugriff auf die SAM-Datenbank der Domäne hat) ist DOMPDC, daher benutzen Sie die Option
<tt class="option">-S</tt>. <i class="replaceable"><tt>Administrator%Passwort</tt></i> ist das Benutzer/Passwort-Paar
für ein Konto, das die nötigen Privilegien hat, um Maschinen der Domäne hinzuzufügen. Wenn dies
erfolgreich ist, werden Sie die Nachricht in Ihrem Terminal-Fenster sehen, die unten gezeigten Text
enthält. Wo alte NT4-artige Domänen-Architektur eingesetzt wird:
</p><pre class="screen">
<tt class="computeroutput">ÜBERSETZUNG VON Joined domain DOM.</tt>
</pre><p>
</p><p>
Wo Active Directory eingesetzt wird:
</p><pre class="screen">
<tt class="computeroutput">ÜBERSETZUNG VON Joined SERV1 to realm MYREALM.</tt>
</pre><p>
</p><p>
Lesen Sie die <b class="command">net</b> man page für mehr Informationen.
</p><p>
Dieser Prozess schließt den Server der Domäne an, ohne davor das Maschinen-Konto auf dem
PDC anlegen zu müssen.
</p><p>
Dieser Befehl durchläuft das Protokoll zum Ändern des Maschinen-Konto-Passworts, dann schreibt
er das neue (zufällige) Maschinen-Konto-Passwort für diesen Samba-Server in eine Datei im selben
Verzeichnis, in welchem normalerweise die Datei smbpasswd gespeichert würde:
</p><pre class="screen">
<tt class="filename">/usr/local/samba/private/secrets.tdb</tt>
oder 
<tt class="filename">/etc/samba/secrets.tdb</tt>.
</pre><p>
</p><p>
Diese Datei wird von root angelegt, gehört root und ist nicht von einem anderen Benutzer lesbar.
Sie ist der Schlüssel zur Domänen-Sicherheit Ihres Systems, und sollte genauso umsichtige behandelt
werden wie eine Shadow-Passwort-Datei.
</p><p>
Zuletzt starten Sie Ihre Samba-Daemonen neu und machen sich bereit für die Clients, die die neue
Domänen-Sicherheit zu benutzen beginnen. Die Art, auf die Sie die Samba-Daemonen neu starten, hängt
von Ihrer Distribution ab, aber in den meisten Fällen wird folgendes ausreichen:
</p><pre class="screen">
<tt class="prompt">root# </tt>/etc/init.d/samba restart
</pre><p>
</p></div><div class="sect2" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="id2901878"></a>Warum ist dies besser als <i class="parameter"><tt>security = server</tt></i>?</h3></div></div><div></div></div><p>
Derzeit befreit Sie die Domänen-Sicherheit in Samba nicht von der Notwendigkeit, lokale 
UNIX-Benutzer anlegen zu müssen, um die Benutzer, die sich an Ihrem Server anmelden, zu repräsentieren.
Das bedeutet, daß wenn sich der Domänen-Benutzer <tt class="constant">DOM\fred</tt> an Ihrem
Samba-Domänen-Server anmeldet, es einen lokalen UNIX-Benutzer fred geben muß, um diesen Benutzer
im UNIX-Datei-System zu repräsentieren. Dies ist ähnlich zum früheren Samba-Betriebsmodus
<a class="indexterm" name="id2901909"></a><i class="parameter"><tt>security</tt></i> = server, wo Samba die
Authentifizierungs-Anfrage an einen Windows NT Server weitergeleitet hat, genau wie es ein
Windows-95- oder Windows-98-Server tun würde.
</p><p>
Lesen Sie das Kapitel <a href="winbind.html" title="Chapter 21. Winbind: Benutzung von Domänenkonten">Winbind: Verwendung von Domänen-Konten</a> für
Informationen darüber, wie ein System automatisch UNIX UIDs und GIDs auf Windows NT Domänen-Benutzer
und -Gruppen zuweisen kann.
</p><p>
Der Vorteil der Domänen-Level-Security ist, daß die Authentifikation in der Domänen-Level-Security
über der authentifizierten RPC-Channel läuft, in exakt derselben Art, wie sie ein NT-Server ausführen
würde. Das bedeutet, daß Samba-Server nunmehr an Domänen-Vertrauens-Verhältnissen in genau derselben
Art teilnehmen wie es NT-Server tun (z.B. können Sie Samba-Server einer Resource-Domäne hinzufügen,
und die Authentifikation vom Resource-Domänen-Controller auf einen Konten-Domänen-PDC weiterleiten).
</p><p>
Zusätzlich dazu muß jeder Samba-Daemon bei gesetzter Option 
<a class="indexterm" name="id2901973"></a><i class="parameter"><tt>security</tt></i> = server eine Verbindung zum
Authentifikations-Server offenhalten, solange der Daemon läuft. Das kann die Ressourcen eines
Microsoft NT Servers stark belasten, und es kann passieren, daß er nicht genügend verfügbare
Verbindungen öffnen kann. Mit <a class="indexterm" name="id2901997"></a><i class="parameter"><tt>security</tt></i> = domain
verbinden sich die Samba-Daemons nur so lange mit dem PDC/BDC, wie es zum Authentifizieren des
Benutzers nötig ist, und trennen dann die Verbindung, schonen damit die Ressourcen des PDCs.
</p><p>
Zuletzt führt das idente Verhalten zu einem NT Server dazu, daß beim Authentifizieren am PDC
der Samba-Server als Teil der Authentifikations-Antwort Benutzer-Informationen wie
die Benutzer-SID, die Liste der Gruppen, der er angehört, und so weiter, erhält.
</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
Ein grosser Teil dieses Dokuments wurde zuerst im Web-Magazin
<a href="http://www.linuxworld.com" target="_top">LinuxWorld</a> veröffentlicht,
als der Artikel
<a href="http://www.linuxworld.com/linuxworld/lw-1998-10/lw-10-samba.html" target="_top">http://www.linuxworld.com/linuxworld/lw-1998-10/lw-10-samba.html</a>
url="http://www.linuxworld.com/linuxworld/lw-1998-10/lw-10-samba.html"/&gt;
<span class="emphasis"><em>Doing the NIS/NT Samba</em></span>.
</p></div></div></div><div class="sect1" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="ads-member"></a>Samba ADS Domänen-Mitgliedschaft</h2></div></div><div></div></div><p>
<a class="indexterm" name="id2902084"></a>
<a class="indexterm" name="id2902092"></a>
<a class="indexterm" name="id2902103"></a>
<a class="indexterm" name="id2902112"></a>
Dies ist eine grobe Anleitung für das Setup von Samba-3 mit Kerberos-Authentifikation an einem
Windows 200x KDC. Vertrautheit mit Kerberos wird vorausgesetzt.
</p><div class="sect2" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="id2902128"></a>Das Konfigurieren von <tt class="filename">smb.conf</tt></h3></div></div><div></div></div><p>
Sie müssen zumindest die folgenden drei Optionen in <tt class="filename">smb.conf</tt> verwenden:
</p><table class="simplelist" border="0" summary="Simple list"><tr><td><i class="parameter"><tt>realm = your.kerberos.REALM</tt></i></td></tr><tr><td><i class="parameter"><tt>security = ADS</tt></i></td></tr><tr><td># The following parameter need only be specified if present.</td></tr><tr><td># The default setting is not present is Yes.</td></tr><tr><td><i class="parameter"><tt>encrypt passwords = yes</tt></i></td></tr></table><p>
In case samba cannot correctly identify the appropriate ADS server using the realm name, use the 
<a class="indexterm" name="id2902200"></a><i class="parameter"><tt>password server</tt></i> option in <tt class="filename">smb.conf</tt>:
</p><table class="simplelist" border="0" summary="Simple list"><tr><td><i class="parameter"><tt>password server = your.kerberos.server</tt></i></td></tr></table><p>
</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
You do <span class="emphasis"><em>not</em></span> need a smbpasswd file, and older clients will be authenticated as 
if <a class="indexterm" name="id2902247"></a><i class="parameter"><tt>security</tt></i> = domain, although it will not do any harm and 
allows you to have local users not in the domain.
</p></div></div><div class="sect2" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="id2902266"></a>Configure <tt class="filename">/etc/krb5.conf</tt></h3></div></div><div></div></div><p>
<a class="indexterm" name="id2902282"></a>
<a class="indexterm" name="id2902291"></a>
With both MIT and Heimdal Kerberos, it is unnecessary to configure the 
<tt class="filename">/etc/krb5.conf</tt>, and it may be detrimental.
</p><p>
Microsoft Active Directory servers automatically create SRV records in the DNS zone 
<i class="parameter"><tt>_kerberos.REALM.NAME</tt></i> for each KDC in the realm. This is part
of the installation and configuration process used to create an Active Directory Domain.
</p><p>
MIT's, as well as Heimdal's, recent KRB5 libraries default to checking for SRV records, so they will 
automatically find the KDCs. In addition, <tt class="filename">krb5.conf</tt> only allows specifying 
a single KDC, even there if there may be more than one. Using the DNS lookup allows the KRB5 
libraries to use whichever KDCs are available.
</p><p>
When manually configuring <tt class="filename">krb5.conf</tt>, the minimal configuration is:
</p><pre class="programlisting">
[libdefaults]
	default_realm = YOUR.KERBEROS.REALM

[realms]
	YOUR.KERBEROS.REALM = {
	kdc = your.kerberos.server
	}

[domain_realms]
	.kerberos.server = YOUR.KERBEROS.REALM
</pre><p>
When using Heimdal versions before 0.6 use the following configuration settings:
</p><pre class="screen">
[libdefaults]
	default_realm      = YOUR.KERBEROS.REALM
	default_etypes     = des-cbc-crc des-cbc-md5
	default_etypes_des = des-cbc-crc des-cbc-md5

[realms]
        YOUR.KERBEROS.REALM = {
        kdc = your.kerberos.server
	}

[domain_realms]
        .kerberos.server = YOUR.KERBEROS.REALM
</pre><p>
</p><p>
<a class="indexterm" name="id2902388"></a>
Test your config by doing a <b class="userinput"><tt>kinit
<i class="replaceable"><tt>USERNAME</tt></i>@<i class="replaceable"><tt>REALM</tt></i></tt></b> and
making sure that your password is accepted by the Win2000 KDC.
</p><p>
With Heimdal versions earlier than 0.6.x you only can use newly created accounts
in ADS or accounts that have had the password changed once after migration, or
in case of <tt class="constant">Administrator</tt> after installation. At the
moment, a Windows 2003 KDC can only be used with a Heimdal releases later than 0.6
(and no default etypes in krb5.conf). Unfortunately this whole area is still
in a state of flux.
</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
The realm must be in uppercase or you will get &#8220;<span class="quote"><span class="errorname">Cannot find KDC for
requested realm while getting initial credentials</span></span>&#8221; error (Kerberos
is case-sensitive!).
</p></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
Time between the two servers must be synchronized. You will get a
&#8220;<span class="quote"><span class="errorname">kinit(v5): Clock skew too great while getting initial credentials</span></span>&#8221;
if the time difference is more than five minutes. 
</p></div><p>
Clock skew limits are configurable in the Kerberos protocols. The default setting is
five minutes.
</p><p>
You also must ensure that you can do a reverse DNS lookup on the IP
address of your KDC. Also, the name that this reverse lookup maps to
must either be the NetBIOS name of the KDC (i.e., the hostname with no
domain attached) or it can alternately be the NetBIOS name followed by the realm. 
</p><p>
The easiest way to ensure you get this right is to add a 
<tt class="filename">/etc/hosts</tt> entry mapping the IP address of your KDC to 
its NetBIOS name. If you do not get this correct then you will get a 
<span class="errorname">local error</span> when you try to join the realm.
</p><p>
If all you want is Kerberos support in <span class="application">smbclient</span> then you can skip
directly to <a href="domain-member.html#ads-test-smbclient" title="Testing with smbclient">Testing with <span class="application">smbclient</span></a> now. 
<a href="domain-member.html#ads-create-machine-account" title="Create the Computer Account">Create the Computer Account</a> and 
<a href="domain-member.html#ads-test-server" title="Testing Server Setup">Testing Server Setup</a>
are needed only if you want Kerberos support for <span class="application">smbd</span> and <span class="application">winbindd</span>.
</p></div><div class="sect2" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="ads-create-machine-account"></a>Create the Computer Account</h3></div></div><div></div></div><p>
As a user who has write permission on the Samba private directory (usually root), run:
</p><pre class="screen">
<tt class="prompt">root# </tt> <b class="userinput"><tt>net ads join -U Administrator%password</tt></b>
</pre><p>
</p><p>
When making a Windows client a member of an ADS domain within a complex organization, you
may want to create the machine account within a particular organizational unit. Samba-3 permits
this to be done using the following syntax:
</p><pre class="screen">
<tt class="prompt">root# </tt> <b class="userinput"><tt>kinit Administrator@your.kerberos.REALM</tt></b>
<tt class="prompt">root# </tt> <b class="userinput"><tt>net ads join &#8220;<span class="quote">organizational_unit</span>&#8221;</tt></b>
</pre><p>
</p><p>
For example, you may want to create the machine account in a container called &#8220;<span class="quote">Servers</span>&#8221;
under the organizational directory &#8220;<span class="quote">Computers\BusinessUnit\Department</span>&#8221; like this:
</p><pre class="screen">
<tt class="prompt">root# </tt> <b class="userinput"><tt>net ads join "Computers\BusinessUnit\Department\Servers"</tt></b>
</pre><p>
</p><div class="sect3" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="id2902679"></a>Possible Errors</h4></div></div><div></div></div><p>
</p><div class="variablelist"><dl><dt><span class="term"><span class="errorname">ADS support not compiled in</span></span></dt><dd><p>Samba must be reconfigured (remove config.cache) and recompiled
	(make clean all install) after the Kerberos libraries and headers files are installed.
	</p></dd><dt><span class="term"><span class="errorname">net ads join prompts for user name</span></span></dt><dd><p>You need to login to the domain using <b class="userinput"><tt>kinit
	<i class="replaceable"><tt>USERNAME</tt></i>@<i class="replaceable"><tt>REALM</tt></i></tt></b>.
	<i class="replaceable"><tt>USERNAME</tt></i> must be a user who has rights to add a machine
	to the domain. </p></dd><dt><span class="term">Unsupported encryption/or checksum types</span></dt><dd><p>
	Make sure that the <tt class="filename">/etc/krb5.conf</tt> is correctly configured
	for the type and version of Kerberos installed on the system.
	</p></dd></dl></div><p>
</p></div></div><div class="sect2" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="ads-test-server"></a>Testing Server Setup</h3></div></div><div></div></div><p>
If the join was successful, you will see a new computer account with the
NetBIOS name of your Samba server in Active Directory (in the &#8220;<span class="quote">Computers</span>&#8221;
folder under Users and Computers.
</p><p>
On a Windows 2000 client, try <b class="userinput"><tt>net use * \\server\share</tt></b>. You should
be logged in with Kerberos without needing to know a password. If this fails then run
<b class="userinput"><tt>klist tickets</tt></b>. Did you get a ticket for the server? Does it have
an encryption type of DES-CBC-MD5? 
</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3>
Samba can use both DES-CBC-MD5 encryption as well as ARCFOUR-HMAC-MD5 encoding.
</div></div><div class="sect2" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="ads-test-smbclient"></a>Testing with <span class="application">smbclient</span></h3></div></div><div></div></div><p>
<a class="indexterm" name="id2902838"></a>
On your Samba server try to login to a Win2000 server or your Samba
server using <span class="application">smbclient</span> and Kerberos. Use <span class="application">smbclient</span> as usual, but
specify the <tt class="option">-k</tt> option to choose Kerberos authentication.
</p></div><div class="sect2" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="id2902867"></a>Notes</h3></div></div><div></div></div><p>
You must change administrator password at least once after DC 
install, to create the right encryption types.
</p><p>
Windows 200x does not seem to create the <i class="parameter"><tt>_kerberos._udp</tt></i> and <i class="parameter"><tt>_ldap._tcp</tt></i> in
the default DNS setup. Perhaps this will be fixed later in service packs.
</p></div></div><div class="sect1" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="id2902904"></a>Sharing User ID Mappings between Samba Domain Members</h2></div></div><div></div></div><p>
Samba maps UNIX users and groups (identified by UIDs and GIDs) to Windows users and groups (identified by SIDs).
These mappings are done by the <i class="parameter"><tt>idmap</tt></i> subsystem of Samba.
</p><p>
In some cases it is useful to share these mappings between Samba Domain Members,
so <span class="emphasis"><em>name-&gt;id</em></span> mapping is identical on all machines.
This may be needed in particular when sharing files over both CIFS and NFS.
</p><p>To use the <span class="emphasis"><em>LDAP</em></span> <i class="parameter"><tt>ldap idmap suffix</tt></i>, set:</p><table class="simplelist" border="0" summary="Simple list"><tr><td><i class="parameter"><tt>ldap idmap suffix = ou=Idmap,dc=quenya,dc=org</tt></i></td></tr></table><p>See the <tt class="filename">smb.conf</tt> man page entry for the <a class="indexterm" name="id2902979"></a><i class="parameter"><tt>ldap idmap suffix</tt></i>
parameter for further information.</p><p>
Do not forget to specify also the <a class="indexterm" name="id2902997"></a><i class="parameter"><tt>ldap admin dn</tt></i>
and to make certain to set the LDAP administrative password into the <tt class="filename">secrets.tdb</tt> using:
</p><pre class="screen">
<tt class="prompt">root# </tt> smbpasswd -w ldap-admin-password
</pre></div><div class="sect1" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="id2903036"></a>Common Errors</h2></div></div><div></div></div><p>
In the process of adding/deleting/re-adding Domain Member machine accounts, there are
many traps for the unwary player and many &#8220;<span class="quote">little</span>&#8221; things that can go wrong.
It is particularly interesting how often subscribers on the Samba mailing list have concluded
after repeated failed attempts to add a machine account that it is necessary to &#8220;<span class="quote">re-install</span>&#8221;
MS Windows on the machine. In truth, it is seldom necessary to reinstall because of this type
of problem. The real solution is often quite simple and with an understanding of how MS Windows
networking functions, it is easy to overcome.
</p><div class="sect2" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="id2903065"></a>Cannot Add Machine Back to Domain</h3></div></div><div></div></div><p>
&#8220;<span class="quote">A Windows workstation was re-installed. The original domain machine
account was deleted and added immediately. The workstation will not join the domain if I use 
the same machine name. Attempts to add the machine fail with a message that the machine already
exists on the network  I know it does not. Why is this failing?</span>&#8221;
</p><p>
The original name is still in the NetBIOS name cache and must expire after machine account
deletion before adding that same name as a Domain Member again. The best advice is to delete
the old account and then add the machine with a new name.
</p></div><div class="sect2" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="id2903099"></a>Adding Machine to Domain Fails</h3></div></div><div></div></div><p>
&#8220;<span class="quote">Adding a Windows 200x or XP Professional machine to the Samba PDC Domain fails with a
message that, <span class="errorname">`The machine could not be added at this time, there is a network problem.
Please try again later.'</span> Why?</span>&#8221;
</p><p>
You should check that there is an <a class="indexterm" name="id2903126"></a><i class="parameter"><tt>add machine script</tt></i> in your <tt class="filename">smb.conf</tt>
file. If there is not, please add one that is appropriate for your OS platform. If a script
has been defined, you will need to debug its operation. Increase the <a class="indexterm" name="id2903150"></a><i class="parameter"><tt>log level</tt></i>
in the <tt class="filename">smb.conf</tt> file to level 10, then try to rejoin the domain. Check the logs to see which
operation is failing.
</p><p>
Possible causes include:
</p><div class="itemizedlist"><ul type="disc"><li><p>
	The script does not actually exist, or could not be located in the path specified.
	</p><p>
	<span class="emphasis"><em>Corrective action:</em></span> Fix it. Make sure when run manually
	that the script will add both the UNIX system account and the Samba SAM account.
	</p></li><li><p>
	The machine could not be added to the UNIX system accounts file <tt class="filename">/etc/passwd</tt>.
	</p><p>
	<span class="emphasis"><em>Corrective action:</em></span> Check that the machine name is a legal UNIX
	system account name. If the UNIX utility <b class="command">useradd</b> is called,
	then make sure that the machine name you are trying to add can be added using this
	tool. <b class="command">Useradd</b> on some systems will not allow any upper case characters
	nor will it allow spaces in the name.
	</p></li></ul></div><p>
The <a class="indexterm" name="id2903244"></a><i class="parameter"><tt>add machine script</tt></i> does not create the
machine account in the Samba backend database, it is there only to create a UNIX system
account to which the Samba backend database account can be mapped.
</p></div><div class="sect2" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="id2903264"></a>I Can't Join a Windows 2003 PDC</h3></div></div><div></div></div><p>Windows 2003 requires SMB signing. Client side SMB signing has been implemented in Samba-3.0.
	Set <a class="indexterm" name="id2903275"></a><i class="parameter"><tt>client use spnego</tt></i> = yes when communicating 
	with a Windows 2003 server.</p></div></div></div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="samba-bdc.html">Prev</a> </td><td width="20%" align="center"><a accesskey="u" href="type.html">Up</a></td><td width="40%" align="right"> <a accesskey="n" href="StandAloneServer.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">Chapter 6. Backup Domänen-Verwaltung </td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top"> Chapter 8. Stand-alone-Server</td></tr></table></div></body></html>
